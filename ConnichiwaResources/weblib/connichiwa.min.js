"use strict";function CWDevice(identifier,options){CWUtil.isObject(options)===!1&&(options={});var passedOptions=options;options={};var defaultOptions={distance:-1};$.extend(options,defaultOptions,passedOptions),this.state=CWDeviceState.DISCOVERED;var _identifier=identifier,_distance=options.distance;return this.updateDistance=function(value){_distance=value},this.getIdentifier=function(){return _identifier},this.getDistance=function(){return _distance},this.canBeConnected=function(){return this.state!==CWDeviceState.CONNECTED&&this.state!==CWDeviceState.CONNECTING&&this.state!==CWDeviceState.LOST},this.isConnected=function(){return this.state===CWDeviceState.CONNECTED},this}var CWDebug=function(){var CWDEBUG=!1,enableDebug=function(){CWDEBUG=!0},log=function(message){CWDEBUG&&console.log("WEBLIB    "+_getDateString()+" -- "+message)},_getDateString=function(date){void 0===date&&(date=new Date);var hours=date.getHours();hours=1===hours.length?"0"+hours:hours;var minutes=date.getMinutes();minutes=1===minutes.length?"0"+minutes:minutes;var seconds=date.getSeconds();seconds=1===seconds.length?"0"+seconds:seconds;var milliseconds=date.getMilliseconds();return milliseconds=1===milliseconds.length?"00"+milliseconds:milliseconds,milliseconds=2===milliseconds.length?"0"+milliseconds:milliseconds,hours+":"+minutes+":"+seconds+"."+milliseconds};return{enableDebug:enableDebug,log:log}}(),CWDeviceState={DISCOVERED:"discovered",CONNECTING:"connecting",CONNECTED:"connected",CONNECTION_FAILED:"connection_failed",DISCONNECTED:"disconnected",LOST:"lost"};CWDevice.prototype.equalTo=function(object){return this.getIdentifier()===object.getIdentifier()},CWDevice.prototype.toString=function(){return this.getIdentifier()};var CWDeviceManager=function(){var _localIdentifier,_remoteDevices=[],setLocalID=function(identifier){return void 0!==_localIdentifier?!1:(_localIdentifier=identifier,CWDebug.log("Local identifier set to "+_localIdentifier),!0)},addDevice=function(newDevice){if(CWDevice.prototype.isPrototypeOf(newDevice)===!1)throw"Cannot add a non-device";null===getDeviceWithIdentifier(newDevice.getIdentifier())&&(_remoteDevices.push(newDevice),CWDebug.log("Added new device: "+newDevice))},removeDevice=function(identifier){var device=getDeviceWithIdentifier(identifier);if(null!==device){var index=_remoteDevices.indexOf(device);_remoteDevices.splice(index,1),CWEventManager.trigger("deviceLost",device)}},getDeviceWithIdentifier=function(identifier){for(var i=0;_remoteDevices.length>i;i++){var remoteDevice=_remoteDevices[i];if(remoteDevice.getIdentifier()===identifier)return remoteDevice}return null};return{setLocalID:setLocalID,addDevice:addDevice,removeDevice:removeDevice,getDeviceWithIdentifier:getDeviceWithIdentifier}}(),CWEventManager=function(){var _events={},register=function(event,callback){if("string"!=typeof event)throw"Event name must be a string";if("function"!=typeof callback)throw"Event callback must be a function";_events[event]||(_events[event]=[]),_events[event].push(callback),CWDebug.log("Attached callback to "+event)},trigger=function(event){if(_events[event]){var args=Array.prototype.slice.call(arguments);args.shift();for(var i=0;_events[event].length>i;i++){var callback=_events[event][i];callback.apply(null,args)}}};return{register:register,trigger:trigger}}(),CWNativeCommunicationParser=function(){var parse=function(message){var object=JSON.parse(message);switch(object.type){case"cwdebug":object.cwdebug&&CWDebug.enableDebug();break;case"localidentifier":var success=CWDeviceManager.setLocalID(object.identifier);success&&CWEventManager.trigger("ready");break;case"devicedetected":var device=CWDeviceManager.getDeviceWithIdentifier(object.identifier);null===device?(device=new CWDevice(object.identifier),CWDeviceManager.addDevice(device)):device.state!==CWDeviceState.CONNECTED&&device.state!==CWDeviceState.CONNECTING&&(device.state=CWDeviceState.DISCOVERED),CWEventManager.trigger("deviceDetected",device);break;case"devicedistancechanged":var device=CWDeviceManager.getDeviceWithIdentifier(object.identifier);if(null===device)return;device.updateDistance(object.distance),CWEventManager.trigger("deviceDistanceChanged",device);break;case"devicelost":var device=CWDeviceManager.getDeviceWithIdentifier(object.identifier);device.state!=CWDeviceState.CONNECTED&&device.state!=CWDeviceState.CONNECTING&&(device.state=CWDeviceState.LOST),CWEventManager.trigger("deviceLost",device);break;case"remoteconnectfailed":var device=CWDeviceManager.getDeviceWithIdentifier(object.identifier);device.state=CWDeviceState.CONNECTING_FAILED,CWEventManager.trigger("connectFailed",device)}};return{parse:parse}}(),CWRemoteCommunicationParser=function(){var parse=function(message){var object=JSON.parse(message);switch(object.type){case"didconnect":var device=CWDeviceManager.getDeviceWithIdentifier(object.identifier);if(null===device)return;device.state=CWDeviceState.CONNECTED,native_remoteDidConnect(device.getIdentifier()),CWEventManager.trigger("deviceConnected",device);break;case"willdisconnect":var device=CWDeviceManager.getDeviceWithIdentifier(object.identifier);if(null===device)return;device.state=CWDeviceState.DISCONNECTED;var data={type:"remoteDisconnected",identifier:object.identifier};Connichiwa._send(JSON.stringify(data)),CWEventManager.trigger("deviceDisconnected",device)}};return{parse:parse}}(),CWUtil=function(){var isInt=function(value){return value===parseInt(value)},isObject=function(value){return"object"==typeof value&&null!==value},inArray=function(value,array){return array.indexOf(value)>-1};return{isInt:isInt,isObject:isObject,inArray:inArray}}(),CWWebserverCommunicationParser=function(){var parse=function(message){var object=JSON.parse(message);switch(object.type){case"debug":CWDebug.CWDEBUG=Boolean(object.cwdebug)}};return{parse:parse}}(),Connichiwa=function(){var _websocket=new WebSocket("ws://127.0.0.1:8001");_websocket.onopen=function(){native_websocketDidOpen(),CWDebug.log("Websocket opened")},_websocket.onmessage=function(e){var message=e.data;CWDebug.log("message: "+message),CWRemoteCommunicationParser.parse(message)},_websocket.onerror=function(){alert("error"),CWDebug.log("Websocket error")},_websocket.onclose=function(){native_websocketDidClose(),CWDebug.log("Websocket closed")};var _send=function(message){_websocket.send(message)},on=function(event,callback){var validEvents=["ready","deviceDetected","deviceDistanceChanged","deviceLost","deviceConnected","deviceDisconnected","connectFailed"];if(CWUtil.inArray(event,validEvents)===!1)throw"Registering for invalid event: "+event;CWEventManager.register(event,callback)},connect=function(device){if(CWDevice.prototype.isPrototypeOf(device)===!1)throw"Need a CWDevice to connect to";device.canBeConnected()!==!1&&(device.state=CWDeviceState.CONNECTING,native_connectRemote(device.getIdentifier()))},send=function(device,message){message.target="remote",message.targetIdentifier=device.getIdentifier(),_send(JSON.stringify(message))};return{_send:_send,on:on,connect:connect,send:send}}();