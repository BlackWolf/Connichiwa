"use strict";function CWDevice(properties){if(!properties.identifier)throw"Cannot instantiate CWDevice without an identifier";CWDebug.log(1,JSON.stringify(properties)),this.discoveryState=CWDeviceDiscoveryState.LOST,this.connectionState=CWDeviceConnectionState.DISCONNECTED,this.distance=-1;var _identifier=properties.identifier,_launchDate=Date.now()/1e3,_ips=[],_port=void 0,_name="unknown",_ppi=CWSystemInfo.DEFAULT_PPI(),_isLocal=!1;return properties.launchDate&&(_launchDate=properties.launchDate),properties.ips&&(_ips=properties.ips),properties.port&&(_port=properties.port),properties.name&&(_name=properties.name),properties.ppi&&properties.ppi>0&&(_ppi=properties.ppi),properties.isLocal&&(_isLocal=properties.isLocal),this.getIdentifier=function(){return _identifier},this.getLaunchDate=function(){return _launchDate},this.getIPs=function(){return _ips},this.getPort=function(){return _port},this.getName=function(){return _name},this.getPPI=function(){return _ppi},this.isLocal=function(){return this._isLocal},this.isNearby=function(){return this.discoveryState===CWDeviceDiscoveryState.DISCOVERED},this.canBeConnected=function(){return this.connectionState===CWDeviceConnectionState.DISCONNECTED&&this.discoveryState===CWDeviceDiscoveryState.DISCOVERED},this.isConnected=function(){return this.connectionState===CWDeviceConnectionState.CONNECTED},this}function CWLocation(x,y,width,height,isLocal){if(isLocal===!0){var global=CWLocation.toGlobal(x,y,width,height);this.x=global.x,this.y=global.y,this.width=global.width,this.height=global.height}else this.x=x,this.y=y,this.width=width,this.height=height;CWEventManager.register("wasUnstitched",function(message){this.x-=message.deviceTransformation.x,this.y-=message.deviceTransformation.y,this.x*=message.deviceTransformation.scale,this.y*=message.deviceTransformation.scale,this.width*=message.deviceTransformation.scale,this.height*=message.deviceTransformation.scale}.bind(this)),CWEventManager.register("wasStitched",function(message){this.x/=message.deviceTransformation.scale,this.y/=message.deviceTransformation.scale,this.width/=message.deviceTransformation.scale,this.height/=message.deviceTransformation.scale,this.x+=message.deviceTransformation.x,this.y+=message.deviceTransformation.y}.bind(this)),this.getGlobal=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},this.getLocal=function(){return CWLocation.toLocal(this.x,this.y,this.width,this.height)},this.getGlobalX=function(){return this.x},this.getGlobalY=function(){return this.y},this.getGlobalWidth=function(){return this.width},this.getGlobalHeight=function(){return this.height},this.getLocalX=function(){return this.getLocal().x},this.getLocalY=function(){return this.getLocal().y},this.getLocalWidth=function(){return this.getLocal().width},this.getLocalHeight=function(){return this.getLocal().height},this.setGlobal=function(x,y,width,height){void 0!==x&&(this.x=x),void 0!==y&&(this.y=y),void 0!==width&&(this.width=width),void 0!==height&&(this.height=height)},this.setLocal=function(x,y,width,height){CWDebug.log(3,"To Global: "+x+", "+y+", "+width+", "+height);var global=CWLocation.toGlobal(x,y,width,height);CWDebug.log(3,JSON.stringify(global)),this.x=global.x,this.y=global.y,this.width=global.width,this.height=global.height},this.setGlobalX=function(v){this.setGlobal(v,this.y,this.width,this.height)},this.setGlobalY=function(v){this.setGlobal(this.x,v,this.width,this.height)},this.setGlobalWidth=function(v){this.setGlobal(this.x,this.y,v,this.height)},this.setGlobalHeight=function(v){this.setGlobal(this.x,this.y,this.width,v)},this.setLocalX=function(v){var local=this.getLocal();this.setLocal(v,local.y,local.width,local.height)},this.setLocalY=function(v){var local=this.getLocal();this.setLocal(local.x,v,local.width,local.height)},this.setLocalWidth=function(v){var local=this.getLocal();this.setLocal(local.x,local.y,v,local.height)},this.setLocalHeight=function(v){var local=this.getLocal();this.setLocal(local.x,local.y,local.width,v)},this.toString=function(){return JSON.stringify(this.getGlobal())},this.copy=function(){return CWLocation.fromString(""+this)}}function CWPoint(x,y,isLocal){return new CWLocation(x,y,void 0,void 0,isLocal)}function CWSize(width,height,isLocal){return new CWLocation(void 0,void 0,width,height,isLocal)}function CWVector(p1,p2){if(void 0===p1||void 0===p2)throw"Cannot instantiate Vector without 2 points";var _p1=p1,_p2=p2,_deltaX=_p2.x-_p1.x,_deltaY=_p2.y-_p1.y,_length=Math.sqrt(Math.pow(_deltaX,2)+Math.pow(_deltaY,2));this.p1=function(){return _p1},this.p2=function(){return _p2},this.deltaX=function(){return _deltaX},this.deltaY=function(){return _deltaY},this.length=function(){return _length}}var OOP=function(){var DEFAULT_PACKAGE_NAME="default",classes={},packages={},createSingleton=function(packageName,className,properties){return void 0===properties&&(properties=className,className=packageName,packageName=DEFAULT_PACKAGE_NAME),_createSingletonInPackage(packageName,className,properties)},_createSingletonInPackage=function(packageName,className,properties){var theClass={"private":function(){},"package":function(){},"public":function(){}};packageName in packages==!1&&(packages[packageName]=function(){});var thePackage=packages[packageName];return thePackage[className]=theClass.package,theClass.private.package=thePackage,packageName in classes==!1&&(classes[packageName]={}),classes[packageName][className]=theClass,_extendSingletonInPackage(packageName,className,properties)},extendSingleton=function(packageName,className,properties){return void 0===properties&&(properties=className,className=packageName,packageName=DEFAULT_PACKAGE_NAME),_extendSingletonInPackage(packageName,className,properties)},_extendSingletonInPackage=function(packageName,className,properties){if(packageName in classes!=!1&&className in classes[packageName]!=!1){var addedConstructor=!1,theClass=classes[packageName][className],getter=function(scope,propertyName){return function(){return scope[propertyName]}},setter=function(scope,propertyName){return function(value){scope[propertyName]=value}},errorGetter=function(){return void 0},errorSetter=function(){throw new TypeError("Cannot set non-visible property")};for(var modifiedPropertyName in properties)if(properties.hasOwnProperty(modifiedPropertyName)){var visibility="private",propertyName=modifiedPropertyName;if(0===propertyName.indexOf("public ")?(visibility="public",propertyName=propertyName.substr(7)):0===propertyName.indexOf("package ")?(visibility="package",propertyName=propertyName.substr(8)):0===propertyName.indexOf("private ")&&(propertyName=propertyName.substr(8)),"function"==typeof properties[modifiedPropertyName]){var theMethod=properties[modifiedPropertyName].bind(theClass.private);switch(visibility){case"private":theClass.private[propertyName]=theMethod;break;case"package":theClass.private[propertyName]=theMethod,theClass.package[propertyName]=theMethod;break;case"public":theClass.private[propertyName]=theMethod,theClass.package[propertyName]=theMethod,theClass.public[propertyName]=theMethod}"__constructor"===propertyName&&(addedConstructor=!0)}else switch(visibility){case"private":theClass.private[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.package,propertyName,{get:errorGetter,set:errorSetter}),Object.defineProperty(theClass.public,propertyName,{get:errorGetter,set:errorSetter});break;case"package":theClass.package[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.private,propertyName,{get:getter(theClass.package,propertyName),set:setter(theClass.package,propertyName)}),Object.defineProperty(theClass.public,propertyName,{get:errorGetter,set:errorSetter});break;case"public":theClass.public[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.private,propertyName,{get:getter(theClass.public,propertyName),set:setter(theClass.public,propertyName)}),Object.defineProperty(theClass.package,propertyName,{get:getter(theClass.public,propertyName),set:setter(theClass.public,propertyName)})}}return addedConstructor===!0&&window.setTimeout(theClass.private.__constructor,0),theClass.public}};return{createSingleton:createSingleton,extendSingleton:extendSingleton}}(),CWDebug=function(){var debug=!0,enableDebug=function(){debug=!0},disableDebug=function(){debug=!1},log=function(priority,message){debug&&console.log(priority+"|"+message)};return{enableDebug:enableDebug,disableDebug:disableDebug,log:log}}(),CWDeviceDiscoveryState={DISCOVERED:"discovered",LOST:"lost"},CWDeviceConnectionState={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected"};CWDevice.prototype.insert=function(target,html){Connichiwa.insert(this.getIdentifier(),target,html)},CWDevice.prototype.replace=function(target,html){Connichiwa.replace(this.getIdentifier(),target,html)},CWDevice.prototype.replaceContent=function(target,html){Connichiwa.replaceContent(this.getIdentifier(),target,html)},CWDevice.prototype.loadScript=function(url,callback){Connichiwa.loadScript(this.getIdentifier(),url,callback)},CWDevice.prototype.send=function(name,message){Connichiwa.send(this.getIdentifier(),name,message)},CWDevice.prototype.equalTo=function(object){return CWDevice.prototype.isPrototypeOf(object)===!1?!1:this.getIdentifier()===object.getIdentifier()},CWDevice.prototype.toString=function(){return this.getIdentifier()};var CWEventManager=function(){var _callbacks={},register=function(event,callback){if("string"!=typeof event)throw"Event name must be a string";if("function"!=typeof callback)throw"Event callback must be a function";if(event=event.toLowerCase(),-1===event.indexOf(" "))_callbacks[event]||(_callbacks[event]=[]),_callbacks[event].push(callback),CWDebug.log(3,"Attached callback to "+event);else for(var events=event.split(" "),i=0;events.length>i;i++)CWEventManager.register(events[i],callback)},trigger=function(logPrio,event){var args=Array.prototype.slice.call(arguments);if(CWUtil.isString(logPrio)===!0?(event=logPrio,logPrio=4,args.shift()):(args.shift(),args.shift()),event=event.toLowerCase(),!_callbacks[event])return CWDebug.log(5,"No callbacks  for "+event+" registered"),void 0;CWDebug.log(logPrio,"Triggering event "+event+" for "+_callbacks[event].length+" callbacks");for(var i=0;_callbacks[event].length>i;i++){var callback=_callbacks[event][i];callback.apply(null,args)}};return{register:register,trigger:trigger}}();$(document).ready(function(){var touchStart,touchLast,touchLastVector,touchAngleReferenceVector,touchCheckable=!1,touchAngleChangedCount=0;$("body").on("mousedown touchstart",function(e){touchStart=CWUtil.getEventLocation(e,"client")}),$("body").on("mousemove touchmove",function(e){if(void 0!==touchStart){var newTouch=CWUtil.getEventLocation(e,"client");if(void 0!==touchLast){var totalTouchVector=new CWVector(touchStart,newTouch),newTouchVector=new CWVector(touchLast,newTouch),touchCheckable=touchCheckable||totalTouchVector.length()>5;if(touchCheckable&&newTouchVector.length()>1)if(void 0!==touchAngleReferenceVector){var referenceTouchAngle=newTouchVector.angle(touchAngleReferenceVector);if(referenceTouchAngle>20){if(touchAngleChangedCount++,3===touchAngleChangedCount)return touchStart=void 0,touchLast=void 0,void 0}else touchAngleReferenceVector=void 0,touchAngleChangedCount=0}else if(void 0!==touchLastVector){var newTouchAngle=newTouchVector.angle(touchLastVector);newTouchAngle>20&&(touchAngleReferenceVector=touchLastVector,touchAngleChangedCount=1)}newTouchVector.length()>0&&(touchLastVector=newTouchVector)}touchLast=newTouch}}),$("body").on("mouseup touchend",function(){var swipeStart=touchStart,swipeEnd=touchLast;if(touchStart=void 0,touchLast=void 0,touchLastVector=void 0,touchCheckable=!1,touchAngleReferenceVector=void 0,touchAngleChangedCount=0,void 0!==swipeStart&&void 0!==swipeEnd){var deltaX=swipeEnd.x-swipeStart.x,deltaY=swipeEnd.y-swipeStart.y,swipeLength=Math.sqrt(Math.pow(deltaX,2)+Math.pow(deltaY,2));if(10>=swipeLength)return CWDebug.log(3,"Swipe REJECTED because it was too short ("+swipeLength+")"),void 0;var xyRatio=.25;100>swipeLength&&(xyRatio=.35),50>swipeLength&&(xyRatio=.4),40>swipeLength&&(xyRatio=.45),15>swipeLength&&(xyRatio=.8);var direction="invalid";Math.abs(deltaY)<Math.abs(deltaX)*xyRatio&&(deltaX>0&&(direction="right"),0>deltaX&&(direction="left")),Math.abs(deltaX)<Math.abs(deltaY)*xyRatio&&(deltaY>0&&(direction="down"),0>deltaY&&(direction="up"));var rubberBanding=$(window).height()-window.innerHeight;swipeEnd.y+=rubberBanding;var endsAtTopEdge=50>=swipeEnd.y,endsAtLeftEdge=50>=swipeEnd.x,endsAtBottomEdge=swipeEnd.y>=$(window).height()-50,endsAtRightEdge=swipeEnd.x>=$(window).width()-50,edge="invalid";if(endsAtTopEdge&&"up"===direction&&(edge="top"),endsAtLeftEdge&&"left"===direction&&(edge="left"),endsAtBottomEdge&&"down"===direction&&(edge="bottom"),endsAtRightEdge&&"right"===direction&&(edge="right"),"invalid"===edge)return CWDebug.log(3,"Swipe REJECTED. Ending: x - "+swipeEnd.x+"/"+($(window).width()-50)+", y - "+swipeEnd.y+"/"+($(window).height()-50)+". Direction: "+direction+". Edge endings: "+endsAtTopEdge+", "+endsAtRightEdge+", "+endsAtBottomEdge+", "+endsAtLeftEdge),void 0;"top"===edge&&(swipeEnd.y=0),"left"===edge&&(swipeEnd.x=0),"bottom"===edge&&(swipeEnd.y=$(window).height()),"right"===edge&&(swipeEnd.x=$(window).width());var swipeData={edge:edge,x:swipeEnd.x,y:swipeEnd.y};CWEventManager.trigger("stitchswipe",swipeData)}})});var CWGyroscope=OOP.createSingleton("Connichiwa","CWGyroscope",{_lastMeasure:void 0,__constructor:function(){gyro.frequency=500,gyro.startTracking(this._onUpdate)},"private _onUpdate":function(o){if(null!==o.alpha&&null!==o.beta&&null!==o.gamma&&null!==o.x&&null!==o.y&&null!==o.z){void 0===this._lastMeasure&&(this._lastMeasure=o);var deltaAlpha=o.alpha-this._lastMeasure.alpha,deltaBeta=o.beta-this._lastMeasure.beta,deltaGamma=o.gamma-this._lastMeasure.gamma,gyroData={alpha:o.alpha,beta:o.beta,gamma:o.gamma,delta:{alpha:deltaAlpha,beta:deltaBeta,gamma:deltaGamma}};CWEventManager.trigger(5,"gyroscopeUpdate",gyroData);var deltaX=o.x-this._lastMeasure.x,deltaY=o.y-this._lastMeasure.y,deltaZ=o.z-this._lastMeasure.z,accelData={x:o.x,y:o.y,z:o.z,delta:{x:deltaX,y:deltaY,z:deltaZ}};CWEventManager.trigger(5,"accelerometerUpdate",accelData),this._lastMeasure={x:o.x,y:o.y,z:o.z,alpha:o.alpha,beta:o.beta,gamma:o.gamma}}},"package getLastGyroscopeMeasure":function(){return void 0===this._lastMeasure?void 0:{alpha:this._lastMeasure.alpha,beta:this._lastMeasure.beta,gamma:this._lastMeasure.gamma}},"package getLastAccelerometerMeasure":function(){return void 0===this._lastMeasure?void 0:{x:this._lastMeasure.x,y:this._lastMeasure.y,z:this._lastMeasure.z}}});CWLocation.toGlobal=function(x,y,width,height){void 0===x&&(x=0),void 0===y&&(y=0),void 0===width&&(width=0),void 0===height&&(height=0);var result={x:x,y:y,width:width,height:height},transformation=CWStitchManager.getDeviceTransformation();return 0===transformation.rotation&&(result.y=y,result.x=x,result.width=width,result.height=height),90===transformation.rotation&&(result.y=transformation.height*transformation.scale-x-width,result.x=y,result.width=height,result.height=width),180===transformation.rotation&&(result.y=transformation.height*transformation.scale-y-height,result.x=transformation.width*transformation.scale-x-width,result.width=width,result.height=height),270===transformation.rotation&&(result.y=x,result.x=transformation.width*transformation.scale-y-height,result.width=height,result.height=width),result.x+=transformation.x*transformation.scale,result.y+=transformation.y*transformation.scale,result.x/=transformation.scale,result.y/=transformation.scale,result.width/=transformation.scale,result.height/=transformation.scale,result},CWLocation.toLocal=function(x,y,width,height){void 0===x&&(x=0),void 0===y&&(y=0),void 0===width&&(width=0),void 0===height&&(height=0);var result={x:x,y:y,width:width,height:height},transformation=CWStitchManager.getDeviceTransformation();return 0===transformation.rotation&&(result.y=y-transformation.y,result.x=x-transformation.x,result.width=width,result.height=height),90===transformation.rotation&&(result.y=x-transformation.x,result.x=transformation.height-(y-transformation.y+height),result.width=height,result.height=width),180===transformation.rotation&&(result.y=transformation.height-(y-transformation.y+height),result.x=transformation.width-(x-transformation.x+width),result.width=width,result.height=height),270===transformation.rotation&&(result.y=transformation.width-(x-transformation.x+width),result.x=y-transformation.y,result.width=height,result.height=width),result.x*=transformation.scale,result.y*=transformation.scale,result.width*=transformation.scale,result.height*=transformation.scale,result},CWLocation.applyRotation=function(x,y,width,height,rotation){var transformation=CWStitchManager.getDeviceTransformation();void 0===x&&(x=0),void 0===y&&(y=0),void 0===width&&(width=0),void 0===height&&(height=0),void 0===rotation&&(rotation=transformation.rotation);var result={x:x,y:y,width:width,height:height};return 0===transformation.rotation&&(result.y=y,result.x=x,result.width=width,result.height=height),90===transformation.rotation&&(result.y=-x,result.x=y,result.width=height,result.height=width),180===transformation.rotation&&(result.y=-y,result.x=-x,result.width=width,result.height=height),270===transformation.rotation&&(result.y=x,result.x=-y,result.width=height,result.height=width),result},CWLocation.fromString=function(s){var obj=JSON.parse(s);return new CWLocation(parseFloat(obj.x),parseFloat(obj.y),parseFloat(obj.width),parseFloat(obj.height),!1)};var CWStitchManager=OOP.createSingleton("Connichiwa","CWStitchManager",{"private _isStitched":!1,"private _deviceTransformation":void 0,"private _gyroDataOnStitch":void 0,"public unstitchOnMove":!0,"public ignoreMoveAxis":[],__constructor:function(){CWEventManager.register("stitchswipe",this._onLocalSwipe),CWEventManager.register("wasStitched",this._onWasStitched),CWEventManager.register("wasUnstitched",this._onWasUnstitched),CWEventManager.register("gyroscopeUpdate",this._onGyroUpdate),CWEventManager.register("accelerometerUpdate",this._onAccelerometerUpdate)},_onWasStitched:function(message){this._gyroDataOnStitch=this.package.CWGyroscope.getLastGyroscopeMeasure(),this._deviceTransformation=message.deviceTransformation,this._isStitched=!0},_onWasUnstitched:function(){this._gyroDataOnStitch=void 0,this._deviceTransformation=this.DEFAULT_DEVICE_TRANSFORMATION(),this._isStitched=!1},_onLocalSwipe:function(swipeData){swipeData.device=Connichiwa.getIdentifier(),swipeData.width=CWSystemInfo.viewportWidth(),swipeData.height=CWSystemInfo.viewportHeight(),Connichiwa.send("master","stitchswipe",swipeData)},_onGyroUpdate:function(gyroData){if(this.isStitched()!==!1&&this.unstitchOnMove!==!1){void 0===this._gyroDataOnStitch&&(this._gyroDataOnStitch=gyroData);var deltaAlpha=Math.abs(gyroData.alpha-this._gyroDataOnStitch.alpha),deltaBeta=Math.abs(gyroData.beta-this._gyroDataOnStitch.beta),deltaGamma=Math.abs(gyroData.gamma-this._gyroDataOnStitch.gamma);deltaAlpha=Math.abs((deltaAlpha+180)%360-180),deltaBeta=Math.abs((deltaBeta+180)%360-180),deltaGamma=Math.abs((deltaGamma+180)%360-180),(CWUtil.inArray("alpha",this.ignoreMoveAxis)===!1&&deltaAlpha>=35||CWUtil.inArray("beta",this.ignoreMoveAxis)===!1&&deltaBeta>=20||CWUtil.inArray("gamma",this.ignoreMoveAxis)===!1&&deltaGamma>=20)&&this._quitStitch()}},_onAccelerometerUpdate:function(accelData){if(this.isStitched()!==!1&&this.unstitchOnMove!==!1){var x=Math.abs(accelData.x),y=Math.abs(accelData.y),z=Math.abs(Math.abs(accelData.z)-9.81);(CWUtil.inArray("x",this.ignoreMoveAxis)===!1&&x>=1||CWUtil.inArray("y",this.ignoreMoveAxis)===!1&&y>=1||CWUtil.inArray("z",this.ignoreMoveAxis)===!1&&z>=1)&&this._quitStitch()}},"private _quitStitch":function(){var data={device:Connichiwa.getIdentifier()};Connichiwa.send("master","quitstitch",data)},"public unstitch":function(){this._quitStitch()},"public isStitched":function(){return this._isStitched},"public getDeviceTransformation":function(){return void 0===this._deviceTransformation?this.DEFAULT_DEVICE_TRANSFORMATION():this._deviceTransformation},"private DEFAULT_DEVICE_TRANSFORMATION":function(){return{x:0,y:0,width:CWSystemInfo.viewportWidth(),height:CWSystemInfo.viewportHeight(),rotation:0,scale:1}}}),CWSystemInfo=OOP.createSingleton("Connichiwa","CWSystemInfo",{_ppi:void 0,"public PPI":function(){return void 0!==this._ppi?this._ppi:(this._ppi=this.DEFAULT_PPI(),window.devicePixelRatio>1&&(this._ppi=142),"iPad"===navigator.platform&&(this._ppi=132),("iPhone"===navigator.platform||"iPod"===navigator.platform)&&(this._ppi=3===window.devicePixelRatio?153:163),this._ppi)},"public isLandscape":function(){return window.innerHeight<window.innerWidth},"public viewportWidth":function(){return $(window).width()},"public viewportHeight":function(){return $(window).height()},"public DEFAULT_PPI":function(){return 100}}),CWUtil=function(){var parseURL=function(url){var parser=document.createElement("a");return parser.href=url,parser},getEventLocation=function(e,type){void 0===type&&(type="page");var pos={x:e[type+"X"],y:e[type+"Y"]};return(void 0===pos.x||void 0===pos.y)&&(pos={x:e.originalEvent.targetTouches[0][type+"X"],y:e.originalEvent.targetTouches[0][type+"Y"]}),pos},randomInt=function(min,max){return void 0===max&&void 0!==min?(max=min,min=0):void 0===max&&void 0===min&&(min=0,max=Number.MAX_VALUE),Math.floor(Math.random()*(max-min+1))+min},isInt=function(value){return value===parseInt(value)},isString=function(value){return"string"==typeof value},isObject=function(value){return"object"==typeof value&&null!==value},inArray=function(value,array){return array.indexOf(value)>-1},createUUID=function(a){return a?(a^16*Math.random()>>a/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,CWUtil.createUUID)};return{parseURL:parseURL,getEventLocation:getEventLocation,randomInt:randomInt,isInt:isInt,isString:isString,isObject:isObject,inArray:inArray,createUUID:createUUID}}();CWVector.prototype.angle=function(otherVector){var vectorsProduct=this.deltaX()*otherVector.deltaX()+this.deltaY()*otherVector.deltaY(),vectorsLength=this.length()*otherVector.length();return Math.acos(vectorsProduct/vectorsLength)*(180/Math.PI)};var CWWebsocketMessageParser=OOP.createSingleton("Connichiwa","CWWebsocketMessageParser",{"package parse":function(message){switch(message._name){case"ack":this._parseAck(message);break;case"_insert":this._parseInsert(message);break;case"_replace":this._parseReplace(message);break;case"loadscript":this._parseLoadScript(message);break;case"wasstitched":this._parseWasStitched(message);break;case"wasunstitched":this._parseWasUnstitched(message);break;case"gotstitchneighbor":this._parseGotStitchNeighbor(message);break;case"remotelog":this._parseRemoteLog(message)}},_parseAck:function(message){CWEventManager.trigger("__messageack__id"+message.original._id)},_parseInsert:function(message){$(message.selector).append(message.html)},_parseReplace:function(message){message.contentOnly===!0?$(message.selector).html(message.html):$(message.selector).replaceWith(message.html)},_parseLoadScript:function(message){var that=this;$.getScript(message.url).done(function(){that.package.Connichiwa._sendAck(message)}).fail(function(f,s,t){CWDebug.log(1,"There was an error loading '"+message.url+"': "+t)})},_parseWasStitched:function(message){CWEventManager.trigger("wasStitched",message)},_parseWasUnstitched:function(message){CWEventManager.trigger("wasUnstitched",message)},_parseGotStitchNeighbor:function(message){CWEventManager.trigger("gotstitchneighbor",message)},_parseRemoteLog:function(message){CWDebug.log(message.priority,"(From "+message._source+") "+message.message)}}),Connichiwa=OOP.createSingleton("Connichiwa","Connichiwa",{"private _websocket":void 0,"public getIdentifier":function(){},"public isMaster":function(){},"public on":function(eventName,callback){return"load"===eventName?(this.onLoad(callback),void 0):(CWEventManager.register(eventName,callback),void 0)},"public onMessage":function(name,callback){this.on("message"+name,callback)},"public onLoad":function(callback){"complete"===document.readyState?callback():Connichiwa.on("ready",callback)},"public insert":function(identifier,target,html){if(void 0===html&&(html=target,target="body"),CWUtil.isObject(target)&&(target="#"+$(target).attr("id")),CWUtil.isObject(html)===!0){var el=$(html),clone=el.clone();clone[0].style.cssText=el[0].style.cssText,html=clone[0].outerHTML}CWDevice.prototype.isPrototypeOf(identifier)&&(identifier=identifier.getIdentifier());var message={selector:target,html:html};this.send(identifier,"_insert",message)},"public replace":function(identifier,target,html){void 0===html&&(html=target,target="body"),this._replace(identifier,target,html,!1)},"public replaceContent":function(identifier,target,html){void 0===html&&(html=target,target="body"),this._replace(identifier,target,html,!0)},"private _replace":function(identifier,target,html,contentOnly){if(void 0===html&&(html=target,target="body"),CWUtil.isObject(target)&&(target="#"+$(target).attr("id")),CWUtil.isObject(html)===!0){var el=$(html),clone=el.clone();clone[0].style.cssText=el[0].style.cssText,html=clone[0].outerHTML}CWDevice.prototype.isPrototypeOf(identifier)&&(identifier=identifier.getIdentifier());var message={selector:target,html:html,contentOnly:contentOnly};this.send(identifier,"_replace",message)},"public loadScript":function(identifier,url,callback){var message={url:url},messageID=this.send(identifier,"loadscript",message);void 0!==callback&&this.on("__messageack__id"+messageID,callback)},"public send":function(target,name,message){return void 0===message&&(message=target,target="master"),CWDevice.prototype.isPrototypeOf(target)&&(target=target.getIdentifier()),message._name=name,message._source=this.getIdentifier(),message._target=target,this._sendObject(message)},"public respond":function(originalMessage,name,responseObject){this.send(originalMessage._source,name,responseObject)},"public broadcast":function(name,message,sendToSelf){this.send("broadcast",name,message),sendToSelf===!0&&this.send(this.getIdentifier(),name,message)},"package _sendAck":function(message){var ackMessage={original:message};this.send(message._source,"ack",ackMessage)},"package _sendObject":function(message){message._id=CWUtil.randomInt();var messageString=JSON.stringify(message);return CWDebug.log(4,"Sending message: "+messageString),this._websocket.send(messageString),message._id},"package _disconnectWebsocket":function(){this._websocket.close()},_cleanupWebsocket:function(){void 0!==this._websocket&&(this._websocket.onopen=void 0,this._websocket.onmessage=void 0,this._websocket.onclose=void 0,this._websocket.onerror=void 0,this._websocket=void 0)}});CWDevice.prototype.connect=function(){this.canBeConnected()!==!1&&(this.connectionState=CWDeviceConnectionState.CONNECTING,nativeCallConnectRemote(this.getIdentifier()))};var CWDeviceManager=function(){var _localDevice,_remoteDevices=[],addDevice=function(newDevice){if(CWDevice.prototype.isPrototypeOf(newDevice)===!1)throw"Cannot add a non-device";return null!==getDeviceWithIdentifier(newDevice.getIdentifier())?!1:(CWDebug.log(3,"Added device: "+newDevice.getIdentifier()),_remoteDevices.push(newDevice),!0)},removeDevice=function(identifier){CWDevice.prototype.isPrototypeOf(identifier)===!0&&(identifier=identifier.getIdentifier());var device=getDeviceWithIdentifier(identifier);if(null===device)return!1;CWDebug.log("Removed device: "+identifier);var index=_remoteDevices.indexOf(device);return _remoteDevices.splice(index,1),!0},getDeviceWithIdentifier=function(identifier){if(void 0!==_localDevice&&(identifier===_localDevice.getIdentifier()||"master"===identifier))return _localDevice;for(var i=0;_remoteDevices.length>i;i++){var remoteDevice=_remoteDevices[i];if(remoteDevice.getIdentifier()===identifier)return remoteDevice}return null},getConnectedDevices=function(){for(var connectedDevices=[],i=0;_remoteDevices.length>i;i++){var remoteDevice=_remoteDevices[i];remoteDevice.isConnected()&&connectedDevices.push(remoteDevice)}return connectedDevices},createLocalDevice=function(properties){return void 0!==_localDevice?!1:(properties.isLocal=!0,_localDevice=new CWDevice(properties),_localDevice.discoveryState=CWDeviceDiscoveryState.LOST,_localDevice.connectionState=CWDeviceConnectionState.CONNECTED,CWDebug.log(3,"Created local device: "+JSON.stringify(properties)),!0)},getLocalDevice=function(){return _localDevice};return{addDevice:addDevice,removeDevice:removeDevice,getDeviceWithIdentifier:getDeviceWithIdentifier,getConnectedDevices:getConnectedDevices,createLocalDevice:createLocalDevice,getLocalDevice:getLocalDevice}}(),CWNativeMasterCommunication=OOP.createSingleton("Connichiwa","CWNativeMasterCommunication",{"public callOnNative":function(methodName){if(this.isRunningNative()===!0){var args=Array.prototype.slice.call(arguments);args.shift();var method=window[methodName];"function"==typeof method?method.apply(null,args):CWDebug.log(1,"ERROR: Tried to call native method with name "+methodName+", but it doesn't exist!")}},"public parse":function(message){CWDebug.log(4,"Parsing native message (master): "+message);var object=JSON.parse(message);switch(object._name){case"cwdebug":this._parseDebug(object);break;case"connectwebsocket":this._parseConnectWebsocket(object);break;case"localinfo":this._parseLocalInfo(object);break;case"devicedetected":this._parseDeviceDetected(object);break;case"devicedistancechanged":this._parseDeviceDistanceChanged(object);break;case"devicelost":this._parseDeviceLost(object);break;case"remoteconnectfailed":this._parseRemoteConnectFailed(object);break;case"remotedisconnected":this._parseRemoteDisconnected(object);break;case"disconnectwebsocket":this._parseDisconnectWebsocket(object)}},_parseDebug:function(message){message.cwdebug===!0?CWDebug.enableDebug():CWDebug.disableDebug()},_parseConnectWebsocket:function(){this.package.Connichiwa._connectWebsocket()},_parseLocalInfo:function(message){var success=CWDeviceManager.createLocalDevice(message);success&&(this.package.Connichiwa._sendObject(message),CWEventManager.trigger("ready"))},_parseDeviceDetected:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);if(null===device&&(device=new CWDevice(message),CWDeviceManager.addDevice(device)),device.discoveryState=CWDeviceDiscoveryState.DISCOVERED,CWDebug.log(2,"Detected device: "+device.getIdentifier()),CWEventManager.trigger("deviceDetected",device),Connichiwa.autoConnect===!0){var localDevice=CWDeviceManager.getLocalDevice();localDevice.getLaunchDate()<device.getLaunchDate()&&device.connect()}},_parseDeviceDistanceChanged:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null!==device&&(device.distance=message.distance,CWDebug.log(5,"Updated distance of device "+device.getIdentifier()+" to "+device.distance),CWEventManager.trigger("deviceDistanceChanged",device))},_parseDeviceLost:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);device.discoveryState=CWDeviceDiscoveryState.LOST,CWDebug.log(2,"Lost device: "+device.getIdentifier()),CWEventManager.trigger("deviceLost",device)},_parseRemoteConnectFailed:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);device.connectionState=CWDeviceConnectionState.DISCONNECTED,CWDebug.log(2,"Connection to remote device failed: "+device.getIdentifier()),CWEventManager.trigger("connectFailed",device)},_parseRemoteDisconnected:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null!==device&&(device.connectionState=CWDeviceConnectionState.DISCONNECTED,CWDebug.log(2,"Device disconnected: "+device.getIdentifier()),CWEventManager.trigger("deviceDisconnected",device))},_parseDisconnectWebsocket:function(){this.package.Connichiwa._disconnectWebsocket()
}});OOP.extendSingleton("Connichiwa","CWStitchManager",{"private _swipes":{},"private _devices":{},"public getDeviceTransformation":function(device,forceRecent){if(void 0===device&&(device=Connichiwa.getIdentifier()),CWDevice.prototype.isPrototypeOf(device)&&(device=device.getIdentifier()),void 0===forceRecent&&(forceRecent=!1),device===Connichiwa.getIdentifier()&&forceRecent!==!0)return void 0===this._deviceTransformation?this.DEFAULT_DEVICE_TRANSFORMATION():this._deviceTransformation;var data=this._getStitchData(device);return void 0===data?this.DEFAULT_DEVICE_TRANSFORMATION():{width:data.width,height:data.height,x:data.transformX,y:data.transformY,rotation:data.rotation,scale:data.scale}},"package detectedSwipe":function(data){var swipe={date:new Date,device:data.device,edge:data.edge,width:data.width,height:data.height,x:data.x,y:data.y},device=CWDeviceManager.getDeviceWithIdentifier(swipe.device);if(null!==device&&device.isConnected()!==!1){CWDebug.log(3,"Detected swipe on "+swipe.device+" on edge "+swipe.edge);for(var key in this._swipes){var savedSwipe=this._swipes[key];if(CWDebug.log(4,"Checking existing swipe: "+key),savedSwipe.device!==swipe.device&&(CWDebug.log(4,"Checking time constraint"),!(swipe.date.getTime()-savedSwipe.date.getTime()>1e3))){CWDebug.log(4,"Checking connection constraint");var savedDevice=CWDeviceManager.getDeviceWithIdentifier(savedSwipe.device);if(null!==savedDevice&&savedDevice.isConnected()!==!1)return this._detectedStitch(savedSwipe,swipe),void 0}}this._swipes[swipe.device]=swipe}},"package unstitchDevice":function(identifier){if(identifier in this._devices){var unstitchMessage={deviceTransformation:this.getDeviceTransformation(identifier)};Connichiwa.send(identifier,"wasunstitched",unstitchMessage),delete this._devices[identifier],CWDebug.log(3,"Device was unstitched: "+identifier)}},"private _detectedStitch":function(firstSwipe,secondSwipe){function rotateSwipe(swipe,rotation){var result={};return 0===rotation&&(result.y=swipe.y,result.x=swipe.x,result.width=swipe.width,result.height=swipe.height),90===rotation&&(result.y=swipe.width-swipe.x,result.x=swipe.y,result.width=swipe.height,result.height=swipe.width),180===rotation&&(result.y=swipe.height-swipe.y,result.x=swipe.width-swipe.x,result.width=swipe.width,result.height=swipe.height),270===rotation&&(result.y=swipe.x,result.x=swipe.height-swipe.y,result.width=swipe.height,result.height=swipe.width),result}if(0===Object.keys(this._devices).length){if(secondSwipe.device===Connichiwa.getIdentifier()){var tempSwipe=firstSwipe;firstSwipe=secondSwipe,secondSwipe=tempSwipe}var stitchData=this._createStitchData(firstSwipe.device);stitchData.width=firstSwipe.width,stitchData.height=firstSwipe.height,this._devices[firstSwipe.device]=stitchData,CWDebug.log(3,"First device was auto-stitched: "+JSON.stringify(stitchData)),CWEventManager.trigger("stitch",secondSwipe.device,firstSwipe.device);var wasstitchMessage={otherDevice:secondSwipe.device,edge:firstSwipe.edge,deviceTransformation:this.getDeviceTransformation(firstSwipe.device,!0)};Connichiwa.send(firstSwipe.device,"wasstitched",wasstitchMessage)}var firstStitchData=this._getStitchData(firstSwipe.device),secondStitchData=this._getStitchData(secondSwipe.device);if(!(void 0===firstStitchData&&void 0===secondStitchData||void 0!==firstStitchData&&void 0!==secondStitchData)){var stitchedSwipe,newSwipe;void 0!==firstStitchData?(stitchedSwipe=firstSwipe,newSwipe=secondSwipe):(stitchedSwipe=secondSwipe,newSwipe=firstSwipe);var stitchedDevice=CWDeviceManager.getDeviceWithIdentifier(stitchedSwipe.device),newDevice=CWDeviceManager.getDeviceWithIdentifier(newSwipe.device),stitchedStitchData=this._getStitchData(stitchedSwipe.device),newStitchData=this._createStitchData(newSwipe.device);newStitchData.scale=newDevice.getPPI()/stitchedDevice.getPPI()*stitchedStitchData.scale;var rotation=0,rotationIndex=this._indexForEdge(stitchedSwipe.edge)-this._indexForEdge(newSwipe.edge);0>rotationIndex&&(rotationIndex+=4),2===rotationIndex&&(rotation=0),3===rotationIndex&&(rotation=90),1===rotationIndex&&(rotation=270),0===rotationIndex&&(rotation=180),newStitchData.rotation=(rotation+stitchedStitchData.rotation)%360;var newRelativeSwipe=rotateSwipe(newSwipe,newStitchData.rotation);newRelativeSwipe.edge=(this._indexForEdge(newSwipe.edge)+newStitchData.rotation/90)%4,newRelativeSwipe.y/=newStitchData.scale,newRelativeSwipe.x/=newStitchData.scale,newRelativeSwipe.width/=newStitchData.scale,newRelativeSwipe.height/=newStitchData.scale;var stitchedRelativeSwipe=rotateSwipe(stitchedSwipe,stitchedStitchData.rotation);stitchedRelativeSwipe.edge=(this._indexForEdge(stitchedSwipe.edge)+stitchedStitchData.rotation/90)%4,stitchedRelativeSwipe.y/=stitchedStitchData.scale,stitchedRelativeSwipe.x/=stitchedStitchData.scale,stitchedRelativeSwipe.width/=stitchedStitchData.scale,stitchedRelativeSwipe.height/=stitchedStitchData.scale,newStitchData.width=newRelativeSwipe.width,newStitchData.height=newRelativeSwipe.height,newStitchData.deviceWidth=newSwipe.width,newStitchData.deviceHeight=newSwipe.height,newStitchData.transformX=stitchedStitchData.transformX+stitchedRelativeSwipe.x-newRelativeSwipe.x,newStitchData.transformY=stitchedStitchData.transformY+stitchedRelativeSwipe.y-newRelativeSwipe.y,this._devices[newSwipe.device]=newStitchData,CWDebug.log(3,"Device was stitched: "+JSON.stringify(newStitchData)),CWEventManager.trigger("stitch",stitchedSwipe.device,newSwipe.device);var wasstitchMessage={otherDevice:stitchedSwipe.device,edge:newSwipe.edge,deviceTransformation:this.getDeviceTransformation(newSwipe.device,!0)};newDevice.send("wasstitched",wasstitchMessage);var gotneighborMessage={otherDevice:newSwipe.device,edge:stitchedSwipe.edge};stitchedDevice.send("gotstitchneighbor",gotneighborMessage)}},"private _createStitchData":function(device){return{device:device,width:0,height:0,transformX:0,transformY:0,rotation:0,scale:1}},"private _getStitchData":function(device){return CWDevice.prototype.isPrototypeOf(device)&&(device=device.getIdentifier()),this._devices[device]},"private _coordinateForEdge":function(edge,point){var axis=this._axisForEdge(edge);return null===axis?null:point[axis]},"private _axisForEdge":function(edge){return"left"===edge||"right"===edge?"y":"top"===edge||"bottom"===edge?"x":null},"private _invertAxis":function(axis){return"x"===axis?"y":"y"===axis?"x":null},"private _oppositeEdge":function(edge){switch(edge){case"top":return"bottom";case"bottom":return"top";case"left":return"right";case"right":return"left"}return"invalid"},"private _indexForEdge":function(edge){switch(edge){case"top":return 0;case"bottom":return 2;case"left":return 1;case"right":return 3}return-1},"private _edgeForIndex":function(index){switch(index){case 0:return"top";case 2:return"bottom";case 3:return"right";case 1:return"left"}return"invalid"}}),OOP.extendSingleton("Connichiwa","CWWebsocketMessageParser",{"package parseOnMaster":function(message){switch(message._name){case"remoteinfo":this._parseRemoteInfo(message);break;case"stitchswipe":this._parseStitchSwipe(message);break;case"quitstitch":this._parseQuitStitch(message)}},_parseRemoteInfo:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null===device?(device=new CWDevice(message),CWDeviceManager.addDevice(device)):CWDebug.log(1,"TODO"),device.connectionState=CWDeviceConnectionState.CONNECTED,nativeCallRemoteDidConnect(device.getIdentifier());var connectedCallback=function(){CWEventManager.trigger("deviceConnected",device)};if(Connichiwa.autoLoadScripts.length>0)for(var i=0;Connichiwa.autoLoadScripts.length>i;i++){var script=Connichiwa.autoLoadScripts[i];i===Connichiwa.autoLoadScripts.length-1?device.loadScript(script,connectedCallback):device.loadScript(script)}else connectedCallback()},_parseStitchSwipe:function(message){this.package.CWStitchManager.detectedSwipe(message)},_parseQuitStitch:function(message){this.package.CWStitchManager.unstitchDevice(message.device)}}),OOP.extendSingleton("Connichiwa","Connichiwa",{"private _connectionAttempts":0,"public autoConnect":!1,"public autoLoadScripts":[],"public getIdentifier":function(){var localDevice=CWDeviceManager.getLocalDevice();return void 0===localDevice?void 0:localDevice.getIdentifier()},"public isMaster":function(){return!0},"public getIPs":function(){var localDevice=CWDeviceManager.getLocalDevice();return void 0===localDevice?void 0:localDevice.getIPs()},"public getPort":function(){var localDevice=CWDeviceManager.getLocalDevice();return void 0===localDevice?void 0:localDevice.getPort()},"package _connectWebsocket":function(){(void 0===this._websocket||this._websocket.state!==CONNECTING&&this._websocket.state!==OPEN)&&(this._cleanupWebsocket(),CWDebug.log(3,"Connecting websocket"),this._websocket=new WebSocket("ws://127.0.0.1:8001"),this._websocket.onopen=this._onWebsocketOpen,this._websocket.onmessage=this._onWebsocketMessage,this._websocket.onclose=this._onWebsocketClose,this._websocket.onerror=this._onWebsocketError,this._connectionAttempts++)},_onWebsocketOpen:function(){CWDebug.log(3,"Websocket opened"),nativeCallWebsocketDidOpen(),this._connectionAttempts=0},_onWebsocketMessage:function(e){var message=JSON.parse(e.data);CWDebug.log(4,"Received message: "+e.data);var that=this;window.requestAnimationFrame(function(){that.package.CWWebsocketMessageParser.parse(message),that.package.CWWebsocketMessageParser.parseOnMaster(message),message._name&&CWEventManager.trigger("message"+message._name,message)})},_onWebsocketClose:function(){return CWDebug.log(3,"Websocket closed"),this._cleanupWebsocket(),this._connectionAttempts>=5?(nativeCallWebsocketDidClose(),void 0):(setTimeout(function(){this._connectWebsocket()},1e3*this._connectionAttempts),void 0)},_onWebsocketError:function(){this._onWebsocketClose()}});