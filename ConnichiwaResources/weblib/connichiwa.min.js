"use strict";function CWVector(p1,p2){if(void 0===p1||void 0===p2)throw"Cannot instantiate Vector without 2 points";var _p1=p1,_p2=p2,_deltaX=_p2.x-_p1.x,_deltaY=_p2.y-_p1.y,_length=Math.sqrt(Math.pow(_deltaX,2)+Math.pow(_deltaY,2));this.p1=function(){return _p1},this.p2=function(){return _p2},this.deltaX=function(){return _deltaX},this.deltaY=function(){return _deltaY},this.length=function(){return _length}}function CWDevice(properties){if(!properties.identifier)throw"Cannot instantiate CWDevice without an identifier";this.discoveryState=CWDeviceDiscoveryState.DISCOVERED,this.connectionState=CWDeviceConnectionState.DISCONNECTED,this.distance=-1;var _identifier=properties.identifier,_name="unknown",_ppi=96,_isLocal=!1;return properties.name&&(_name=properties.name),properties.ppi&&properties.ppi>0&&(_ppi=properties.ppi),properties.isLocal&&(_isLocal=properties.isLocal),this.getIdentifier=function(){return _identifier},this.getPPI=function(){return _ppi},this.isLocal=function(){return this._isLocal},this.isNearby=function(){return this.discoveryState===CWDeviceDiscoveryState.DISCOVERED},this.canBeConnected=function(){return this.connectionState===CWDeviceConnectionState.DISCONNECTED&&this.discoveryState===CWDeviceDiscoveryState.DISCOVERED},this.isConnected=function(){return this.connectionState===CWDeviceConnectionState.CONNECTED},this}var OOP=function(){var DEFAULT_PACKAGE_NAME="default",classes={},packages={},createSingleton=function(packageName,className,properties){return void 0===properties&&(properties=className,className=packageName,packageName=DEFAULT_PACKAGE_NAME),_createSingletonInPackage(packageName,className,properties)},_createSingletonInPackage=function(packageName,className,properties){var theClass={"private":function(){},"package":function(){},"public":function(){}};packageName in packages==!1&&(packages[packageName]=function(){});var thePackage=packages[packageName];return thePackage[className]=theClass.package,theClass.private.package=thePackage,packageName in classes==!1&&(classes[packageName]={}),classes[packageName][className]=theClass,_extendSingletonInPackage(packageName,className,properties)},extendSingleton=function(packageName,className,properties){return void 0===properties&&(properties=className,className=packageName,packageName=DEFAULT_PACKAGE_NAME),_extendSingletonInPackage(packageName,className,properties)},_extendSingletonInPackage=function(packageName,className,properties){if(packageName in classes!=!1&&className in classes[packageName]!=!1){var theClass=classes[packageName][className],getter=function(scope,propertyName){return function(){return scope[propertyName]}},setter=function(scope,propertyName){return function(value){scope[propertyName]=value}},errorGetter=function(){return void 0},errorSetter=function(){throw new TypeError("Cannot set non-visible property")};for(var modifiedPropertyName in properties)if(properties.hasOwnProperty(modifiedPropertyName)){var visibility="private",propertyName=modifiedPropertyName;if(0===propertyName.indexOf("public ")?(visibility="public",propertyName=propertyName.substr(7)):0===propertyName.indexOf("package ")?(visibility="package",propertyName=propertyName.substr(8)):0===propertyName.indexOf("private ")&&(propertyName=propertyName.substr(8)),"function"==typeof properties[modifiedPropertyName]){var theMethod=properties[modifiedPropertyName].bind(theClass.private);switch(visibility){case"private":theClass.private[propertyName]=theMethod;break;case"package":theClass.private[propertyName]=theMethod,theClass.package[propertyName]=theMethod;break;case"public":theClass.private[propertyName]=theMethod,theClass.package[propertyName]=theMethod,theClass.public[propertyName]=theMethod}}else switch(visibility){case"private":theClass.private[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.package,propertyName,{get:errorGetter,set:errorSetter}),Object.defineProperty(theClass.public,propertyName,{get:errorGetter,set:errorSetter});break;case"package":theClass.package[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.private,propertyName,{get:getter(theClass.package,propertyName),set:setter(theClass.package,propertyName)}),Object.defineProperty(theClass.public,propertyName,{get:errorGetter,set:errorSetter});break;case"public":theClass.public[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.private,propertyName,{get:getter(theClass.public,propertyName),set:setter(theClass.public,propertyName)}),Object.defineProperty(theClass.package,propertyName,{get:getter(theClass.public,propertyName),set:setter(theClass.public,propertyName)})}}return theClass.public}};return{createSingleton:createSingleton,extendSingleton:extendSingleton}}(),CWDebug=function(){var debug=!1,enableDebug=function(){debug=!0},log=function(priority,message){debug&&console.log(priority+"|"+message)};return{enableDebug:enableDebug,log:log}}(),CWEventManager=function(){var _events={},register=function(event,callback){if("string"!=typeof event)throw"Event name must be a string";if("function"!=typeof callback)throw"Event callback must be a function";_events[event]||(_events[event]=[]),_events[event].push(callback),CWDebug.log(3,"Attached callback to "+event)},trigger=function(event){if(CWDebug.log(4,"Triggering event "+event),!_events[event])return CWDebug.log(1,"No callbacks registered"),void 0;var args=Array.prototype.slice.call(arguments);args.shift();for(var i=0;_events[event].length>i;i++){var callback=_events[event][i];callback.apply(null,args)}};return{register:register,trigger:trigger}}();$(document).ready(function(){var touchStart,touchLast,touchLastVector,touchAngleReferenceVector,touchCheckable=!1,touchAngleChangedCount=0;$("body").on("mousedown touchstart",function(e){touchStart=CWUtil.getEventLocation(e,"client")}),$("body").on("mousemove touchmove",function(e){if(void 0!==touchStart){var newTouch=CWUtil.getEventLocation(e,"client");if(void 0!==touchLast){var totalTouchVector=new CWVector(touchStart,newTouch),newTouchVector=new CWVector(touchLast,newTouch),touchCheckable=touchCheckable||totalTouchVector.length()>5;if(touchCheckable&&newTouchVector.length()>1)if(void 0!==touchAngleReferenceVector){var referenceTouchAngle=newTouchVector.angle(touchAngleReferenceVector);if(referenceTouchAngle>20){if(touchAngleChangedCount++,3===touchAngleChangedCount)return touchStart=void 0,touchLast=void 0,void 0}else touchAngleReferenceVector=void 0,touchAngleChangedCount=0}else if(void 0!==touchLastVector){var newTouchAngle=newTouchVector.angle(touchLastVector);newTouchAngle>20&&(touchAngleReferenceVector=touchLastVector,touchAngleChangedCount=1)}newTouchVector.length()>0&&(touchLastVector=newTouchVector)}touchLast=newTouch}}),$("body").on("mouseup touchend",function(){var swipeStart=touchStart,swipeEnd=touchLast;if(touchStart=void 0,touchLast=void 0,touchLastVector=void 0,touchCheckable=!1,touchAngleReferenceVector=void 0,touchAngleChangedCount=0,void 0!==swipeStart&&void 0!==swipeEnd){var deltaX=swipeEnd.x-swipeStart.x,deltaY=swipeEnd.y-swipeStart.y,swipeLength=Math.sqrt(Math.pow(deltaX,2)+Math.pow(deltaY,2));if(!(10>=swipeLength)){var xyRatio=.25;100>swipeLength&&(xyRatio=.35),50>swipeLength&&(xyRatio=.4),40>swipeLength&&(xyRatio=.45),15>swipeLength&&(xyRatio=.8);var direction="invalid";Math.abs(deltaY)<Math.abs(deltaX)*xyRatio&&(deltaX>0&&(direction="right"),0>deltaX&&(direction="left")),Math.abs(deltaX)<Math.abs(deltaY)*xyRatio&&(deltaY>0&&(direction="down"),0>deltaY&&(direction="up"));var endsAtTopEdge=25>=swipeEnd.y,endsAtLeftEdge=25>=swipeEnd.x,endsAtBottomEdge=swipeEnd.y>=screen.availHeight-25,endsAtRightEdge=swipeEnd.x>=screen.availWidth-25,edge="invalid";if(endsAtTopEdge&&"up"===direction&&(edge="top"),endsAtLeftEdge&&"left"===direction&&(edge="left"),endsAtBottomEdge&&"down"===direction&&(edge="bottom"),endsAtRightEdge&&"right"===direction&&(edge="right"),"invalid"!==edge){var message={type:"pinchswipe",device:Connichiwa.getIdentifier(),edge:edge,width:screen.availWidth,height:screen.availHeight,x:swipeEnd.x,y:swipeEnd.y};Connichiwa.send(message)}}}})});var CWUtil=function(){var parseURL=function(url){var parser=document.createElement("a");return parser.href=url,parser},getEventLocation=function(e,type){void 0===type&&(type="page");var pos={x:e[type+"X"],y:e[type+"Y"]};return(void 0===pos.x||void 0===pos.y)&&(pos={x:e.originalEvent.targetTouches[0][type+"X"],y:e.originalEvent.targetTouches[0][type+"Y"]}),pos},isInt=function(value){return value===parseInt(value)},isObject=function(value){return"object"==typeof value&&null!==value},inArray=function(value,array){return array.indexOf(value)>-1};return{parseURL:parseURL,getEventLocation:getEventLocation,isInt:isInt,isObject:isObject,inArray:inArray}}();CWVector.prototype.angle=function(otherVector){var vectorsProduct=this.deltaX()*otherVector.deltaX()+this.deltaY()*otherVector.deltaY(),vectorsLength=this.length()*otherVector.length();return Math.acos(vectorsProduct/vectorsLength)*(180/Math.PI)};var Connichiwa=OOP.createSingleton("Connichiwa","Connichiwa",{"private _websocket":void 0,"public getIdentifier":function(){},"public send":function(){},"public broadcast":function(){},"public isMaster":function(){},"public onMessage":function(type,callback){CWEventManager.register("message"+type,callback)},"package _disconnectWebsocket":function(){this._websocket.close()},"package _sendObject":function(messageObject){this._send(JSON.stringify(messageObject))},"package _send":function(message){CWDebug.log(4,"Sending message: "+message),this._websocket.send(message)},_cleanupWebsocket:function(){void 0!==this._websocket&&(this._websocket.onopen=void 0,this._websocket.onmessage=void 0,this._websocket.onclose=void 0,this._websocket.onerror=void 0,this._websocket=void 0)}}),CWDeviceDiscoveryState={DISCOVERED:"discovered",LOST:"lost"},CWDeviceConnectionState={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected"};CWDevice.prototype.connect=function(){this.canBeConnected()!==!1&&(this.connectionState=CWDeviceConnectionState.CONNECTING,nativeCallConnectRemote(this.getIdentifier()))},CWDevice.prototype.send=function(messageObject){Connichiwa.send(this.getIdentifier(),messageObject)},CWDevice.prototype.equalTo=function(object){return CWDevice.prototype.isPrototypeOf(object)===!1?!1:this.getIdentifier()===object.getIdentifier()},CWDevice.prototype.toString=function(){return this.getIdentifier()};var CWDeviceManager=function(){var _localDevice,_remoteDevices=[],addDevice=function(newDevice){if(CWDevice.prototype.isPrototypeOf(newDevice)===!1)throw"Cannot add a non-device";return null!==getDeviceWithIdentifier(newDevice.getIdentifier())?!1:(CWDebug.log(3,"Added device: "+newDevice.getIdentifier()),_remoteDevices.push(newDevice),!0)},removeDevice=function(identifier){CWDevice.prototype.isPrototypeOf(identifier)===!0&&(identifier=identifier.getIdentifier());var device=getDeviceWithIdentifier(identifier);if(null===device)return!1;CWDebug.log("Removed device: "+identifier);var index=_remoteDevices.indexOf(device);return _remoteDevices.splice(index,1),!0},getDeviceWithIdentifier=function(identifier){if(void 0!==_localDevice&&(identifier===_localDevice.getIdentifier()||"master"===identifier))return _localDevice;for(var i=0;_remoteDevices.length>i;i++){var remoteDevice=_remoteDevices[i];if(remoteDevice.getIdentifier()===identifier)return remoteDevice}return null},getConnectedDevices=function(){for(var connectedDevices=[],i=0;_remoteDevices.length>i;i++){var remoteDevice=_remoteDevices[i];remoteDevice.isConnected()&&connectedDevices.push(remoteDevice)}return connectedDevices},createLocalDevice=function(properties){return void 0!==_localDevice?!1:(properties.isLocal=!0,_localDevice=new CWDevice(properties),_localDevice.discoveryState=CWDeviceDiscoveryState.LOST,_localDevice.connectionState=CWDeviceConnectionState.CONNECTED,CWDebug.log(3,"Created local device: "+JSON.stringify(properties)),!0)},getLocalDevice=function(){return _localDevice};return{addDevice:addDevice,removeDevice:removeDevice,getDeviceWithIdentifier:getDeviceWithIdentifier,getConnectedDevices:getConnectedDevices,createLocalDevice:createLocalDevice,getLocalDevice:getLocalDevice}}(),CWNativeMasterCommunication=OOP.createSingleton("Connichiwa","CWNativeMasterCommunication",{"public parse":function(message){CWDebug.log(4,"Parsing native message (master): "+message);var object=JSON.parse(message);switch(object.type){case"connectwebsocket":this._parseConnectWebsocket(object);break;case"cwdebug":this._parseDebug(object);break;case"localidentifier":this._parseLocalIdentifier(object);break;case"devicedetected":this._parseDeviceDetected(object);break;case"devicedistancechanged":this._parseDeviceDistanceChanged(object);break;case"devicelost":this._parseDeviceLost(object);break;case"remoteconnectfailed":this._parseRemoteConnectFailed(object);break;case"remotedisconnected":this._parseRemoteDisconnected(object);break;case"disconnectwebsocket":this._parseDisconnectWebsocket(object)}},_parseConnectWebsocket:function(){this.package.Connichiwa._connectWebsocket()},_parseDebug:function(message){message.cwdebug&&CWDebug.enableDebug()},_parseLocalIdentifier:function(message){var success=CWDeviceManager.createLocalDevice(message);success&&(this.package.Connichiwa._sendObject(message),CWEventManager.trigger("ready"))},_parseDeviceDetected:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null===device&&(device=new CWDevice(message),CWDeviceManager.addDevice(device)),device.discoveryState=CWDeviceDiscoveryState.DISCOVERED,CWDebug.log(2,"Detected device: "+device.getIdentifier()),CWEventManager.trigger("deviceDetected",device)},_parseDeviceDistanceChanged:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null!==device&&(device.distance=message.distance,CWDebug.log(5,"Updated distance of device "+device.getIdentifier()+" to "+device.distance),CWEventManager.trigger("deviceDistanceChanged",device))},_parseDeviceLost:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);device.discoveryState=CWDeviceDiscoveryState.LOST,CWDebug.log(2,"Lost device: "+device.getIdentifier()),CWEventManager.trigger("deviceLost",device)},_parseRemoteConnectFailed:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);device.connectionState=CWDeviceConnectionState.DISCONNECTED,CWDebug.log(2,"Connection to remote device failed: "+device.getIdentifier()),CWEventManager.trigger("connectFailed",device)},_parseRemoteDisconnected:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null!==device&&(device.connectionState=CWDeviceConnectionState.DISCONNECTED,CWDebug.log(2,"Device disconnected: "+device.getIdentifier()),CWEventManager.trigger("deviceDisconnected",device))},_parseDisconnectWebsocket:function(){this.package.Connichiwa._disconnectWebsocket()}}),CWPinchManager=OOP.createSingleton("Connichiwa","CWPinchManager",{"private _swipes":{},"private _devices":{},"public getDeviceTransformation":function(device){return device.getIdentifier()in this._devices==!1?{x:0,y:0,scale:1}:{x:this._devices[device.getIdentifier()].transformX,y:this._devices[device.getIdentifier()].transformY,scale:this._devices[device.getIdentifier()].scale}},"package detectedSwipe":function(data){CWDebug.log(3,"Detected swipe on "+data.edge+" edge, device "+data.device);var device=CWDeviceManager.getDeviceWithIdentifier(data.device);if(null!==device&&device.isConnected()!==!1){var now=new Date;for(var key in this._swipes){var savedSwipe=this._swipes[key];if(savedSwipe.data.device!==data.device&&!(now.getTime()-savedSwipe.date.getTime()>1e3)){var otherDevice=CWDeviceManager.getDeviceWithIdentifier(savedSwipe.data.device);if(null!==otherDevice&&otherDevice.isConnected()!==!1)return this._detectedPinch(device,data,otherDevice,savedSwipe.data),void 0}}CWDebug.log(3,"Adding swipe "+data.device),this._swipes[data.device]={date:now,data:data}}},"private _detectedPinch":function(firstDevice,firstData,secondDevice,secondData){if(0===Object.keys(this._devices).length){var localDevice=CWDeviceManager.getLocalDevice(),localData={width:screen.availWidth,height:screen.availHeight};this._devices[localDevice.getIdentifier()]=this._createNewPinchData(localDevice,localData)}CWDebug.log(3,"Detected pinch");var firstPinchedDevice=this._getPinchedDevice(firstDevice),secondPinchedDevice=this._getPinchedDevice(secondDevice);if(!(void 0===firstPinchedDevice&&void 0===secondPinchedDevice||void 0!==firstPinchedDevice&&void 0!==secondPinchedDevice)){var pinchedDevice,newDevice,pinchedData,newData;void 0!==firstPinchedDevice?(pinchedDevice=firstPinchedDevice,pinchedData=firstData,newDevice=secondDevice,newData=secondData):(pinchedDevice=secondPinchedDevice,pinchedData=secondData,newDevice=firstDevice,newData=firstData),pinchedDevice[pinchedData.edge][newDevice.getIdentifier()]=this._coordinateForEdge(pinchedData.edge,pinchedData);var newPinchDevice=this._createNewPinchData(newDevice,newData);newPinchDevice[newData.edge][pinchedDevice.device.getIdentifier()]=this._coordinateForEdge(newData.edge,newData),newPinchDevice.scale=newPinchDevice.device.getPPI()/pinchedDevice.device.getPPI()*pinchedDevice.scale,CWDebug.log(1,newPinchDevice.device.getPPI()+" / "+pinchedDevice.device.getPPI()+" * "+pinchedDevice.scale+" = "+newPinchDevice.scale),"right"===pinchedData.edge?(newPinchDevice.transformX=pinchedDevice.transformX+pinchedDevice.width/pinchedDevice.scale,newPinchDevice.transformY=pinchedDevice.transformY+pinchedData.y/pinchedDevice.scale-newData.y*newPinchDevice.scale):"bottom"===pinchedData.edge?(newPinchDevice.transformX=pinchedDevice.transformX+pinchedData.x-newData.x*newPinchDevice.scale,newPinchDevice.transformY=pinchedDevice.transformY+pinchedDevice.height):"left"===pinchedData.edge?(newPinchDevice.transformX=pinchedDevice.transformX-newPinchDevice.width,newPinchDevice.transformY=pinchedDevice.transformY+pinchedData.y-newData.y*newPinchDevice.scale):"top"===pinchedData.edge&&(newPinchDevice.transformX=pinchedDevice.transformX+pinchedData.x-newData.x*newPinchDevice.scale,newPinchDevice.transformY=pinchedDevice.transformY-newPinchDevice.height),this._devices[newDevice.getIdentifier()]=newPinchDevice,CWDebug.log(1,"Got pinch, devices look like this: "+JSON.stringify(this._devices)),CWEventManager.trigger("pinch",newDevice)}},"private _getPinchedDevice":function(device){return device.getIdentifier()in this._devices?this._devices[device.getIdentifier()]:void 0},"private _createNewPinchData":function(device,data){return{device:device,width:data.width,height:data.height,transformX:0,transformY:0,scale:1,left:{},right:{},top:{},bottom:{}}},"private _coordinateForEdge":function(edge,point){var axis=this._axisForEdge(edge);return null===axis?null:point[axis]},"private _axisForEdge":function(edge){return"left"===edge||"right"===edge?"y":"top"===edge||"bottom"===edge?"x":null},"private _invertAxis":function(axis){return"x"===axis?"y":"y"===axis?"x":null},"private _oppositeEdge":function(edge){switch(edge){case"top":return"bottom";case"bottom":return"top";case"left":return"right";case"right":return"left"}return"invalid"}}),CWRemoteCommunication=OOP.createSingleton("Connichiwa","CWRemoteCommunication",{"public parse":function(message){switch(message.type){case"remoteidentifier":this._parseRemoteIdentifier(message);break;case"pinchswipe":this._parsePinchSwipe(message)}},_parseRemoteIdentifier:function(message){var device=CWDeviceManager.getDeviceWithIdentifier(message.identifier);null!==device&&(device.connectionState=CWDeviceConnectionState.CONNECTED,nativeCallRemoteDidConnect(device.getIdentifier()),setTimeout(function(){CWEventManager.trigger("deviceConnected",device)},1e3))},_parsePinchSwipe:function(message){this.package.CWPinchManager.detectedSwipe(message)}});OOP.extendSingleton("Connichiwa","Connichiwa",{"private _connectionAttempts":0,"public getIdentifier":function(){var localDevice=CWDeviceManager.getLocalDevice();return void 0===localDevice?void 0:localDevice.getIdentifier()},"public isMaster":function(){return!0},"public send":function(identifier,messageObject){return"broadcast"===identifier?(this.broadcast(messageObject),void 0):void 0===messageObject?(messageObject=identifier,identifier=void 0,messageObject.target="master",messageObject.source="master",CWRemoteCommunication.parse(messageObject),void 0):(messageObject.source="master",messageObject.target=identifier,this._sendObject(messageObject),void 0)},"public broadcast":function(messageObject){messageObject.source="master",messageObject.target="broadcast",this._sendObject(messageObject)},"public on":function(event,callback){var validEvents=["ready","deviceDetected","deviceDistanceChanged","deviceLost","deviceConnected","deviceDisconnected","connectFailed","pinch"];if(CWUtil.inArray(event,validEvents)===!1)throw"Registering for invalid event: "+event;CWEventManager.register(event,callback)},"package _connectWebsocket":function(){(void 0===this._websocket||this._websocket.state!==CONNECTING&&this._websocket.state!==OPEN)&&(this._cleanupWebsocket(),CWDebug.log(3,"Connecting websocket"),this._websocket=new WebSocket("ws://127.0.0.1:8001"),this._websocket.onopen=this._onWebsocketOpen,this._websocket.onmessage=this._onWebsocketMessage,this._websocket.onclose=this._onWebsocketClose,this._websocket.onerror=this._onWebsocketError,this._connectionAttempts++)},_onWebsocketOpen:function(){CWDebug.log(3,"Websocket opened"),nativeCallWebsocketDidOpen(),this._connectionAttempts=0},_onWebsocketMessage:function(e){var message=JSON.parse(e.data);CWDebug.log(4,"Received message: "+e.data),window.requestAnimationFrame(function(){CWRemoteCommunication.parse(message),message.type&&CWEventManager.trigger("message"+message.type,message)})},_onWebsocketClose:function(){return CWDebug.log(3,"Websocket closed"),this._cleanupWebsocket(),this._connectionAttempts>=5?(nativeCallWebsocketDidClose(),void 0):(setTimeout(function(){this._connectWebsocket()},1e3*this._connectionAttempts),void 0)},_onWebsocketError:function(){this._onWebsocketClose()}});