"use strict";function CWDevice(e){if(!e.identifier)throw"Cannot instantiate CWDevice without an identifier";this.discoveryState=CWDeviceDiscoveryState.LOST,this.connectionState=CWDeviceConnectionState.DISCONNECTED,this.distance=-1;var t=e.identifier,i=Date.now()/1e3,n=[],a=void 0,o="unknown",r=CWSystemInfo.DEFAULT_PPI(),c=!1;return e.launchDate&&(i=e.launchDate),e.ips&&(n=e.ips),e.port&&(a=e.port),e.name&&(o=e.name),e.ppi&&e.ppi>0&&(r=e.ppi),e.isLocal&&(c=e.isLocal),this.getIdentifier=function(){return t},this.getLaunchDate=function(){return i},this.getIPs=function(){return n},this.getPort=function(){return a},this.getName=function(){return o},this.getPPI=function(){return r},this.isLocal=function(){return this._isLocal},this.isNearby=function(){return this.discoveryState===CWDeviceDiscoveryState.DISCOVERED},this.canBeConnected=function(){return this.connectionState===CWDeviceConnectionState.DISCONNECTED&&this.discoveryState===CWDeviceDiscoveryState.DISCOVERED},this.isConnected=function(){return this.connectionState===CWDeviceConnectionState.CONNECTED},this}function CWLocation(e,t,i,n,a){if(a===!0){var o=CWLocation.toGlobal(e,t,i,n);this.x=o.x,this.y=o.y,this.width=o.width,this.height=o.height}else this.x=e,this.y=t,this.width=i,this.height=n;CWEventManager.register("wasUnstitched",function(e){this.x-=e.deviceTransformation.x,this.y-=e.deviceTransformation.y,this.x*=e.deviceTransformation.scale,this.y*=e.deviceTransformation.scale,this.width*=e.deviceTransformation.scale,this.height*=e.deviceTransformation.scale}.bind(this)),CWEventManager.register("wasStitched",function(e){this.x/=e.deviceTransformation.scale,this.y/=e.deviceTransformation.scale,this.width/=e.deviceTransformation.scale,this.height/=e.deviceTransformation.scale,this.x+=e.deviceTransformation.x,this.y+=e.deviceTransformation.y}.bind(this)),this.getGlobal=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},this.getLocal=function(){return CWLocation.toLocal(this.x,this.y,this.width,this.height)},this.getGlobalX=function(){return this.x},this.getGlobalY=function(){return this.y},this.getGlobalWidth=function(){return this.width},this.getGlobalHeight=function(){return this.height},this.getLocalX=function(){return this.getLocal().x},this.getLocalY=function(){return this.getLocal().y},this.getLocalWidth=function(){return this.getLocal().width},this.getLocalHeight=function(){return this.getLocal().height},this.setGlobal=function(e,t,i,n){void 0!==e&&(this.x=e),void 0!==t&&(this.y=t),void 0!==i&&(this.width=i),void 0!==n&&(this.height=n)},this.setLocal=function(e,t,i,n){CWDebug.log(3,"To Global: "+e+", "+t+", "+i+", "+n);var a=CWLocation.toGlobal(e,t,i,n);CWDebug.log(3,JSON.stringify(a)),this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height},this.setGlobalX=function(e){this.setGlobal(e,this.y,this.width,this.height)},this.setGlobalY=function(e){this.setGlobal(this.x,e,this.width,this.height)},this.setGlobalWidth=function(e){this.setGlobal(this.x,this.y,e,this.height)},this.setGlobalHeight=function(e){this.setGlobal(this.x,this.y,this.width,e)},this.setLocalX=function(e){var t=this.getLocal();this.setLocal(e,t.y,t.width,t.height)},this.setLocalY=function(e){var t=this.getLocal();this.setLocal(t.x,e,t.width,t.height)},this.setLocalWidth=function(e){var t=this.getLocal();this.setLocal(t.x,t.y,e,t.height)},this.setLocalHeight=function(e){var t=this.getLocal();this.setLocal(t.x,t.y,t.width,e)},this.toString=function(){return JSON.stringify(this.getGlobal())},this.copy=function(){return CWLocation.fromString(this.toString())}}function CWPoint(e,t,i){return new CWLocation(e,t,void 0,void 0,i)}function CWSize(e,t,i){return new CWLocation(void 0,void 0,e,t,i)}function CWVector(e,t){if(void 0===e||void 0===t)throw"Cannot instantiate Vector without 2 points";var i=e,n=t,a=n.x-i.x,o=n.y-i.y,r=Math.sqrt(Math.pow(a,2)+Math.pow(o,2));this.p1=function(){return i},this.p2=function(){return n},this.deltaX=function(){return a},this.deltaY=function(){return o},this.length=function(){return r}}var OOP=function(){var e="default",t={},i={},n=function(t,i,n){return void 0===n&&(n=i,i=t,t=e),a(t,i,n)},a=function(e,n,a){var o={private:function(){},package:function(){},public:function(){}};e in i==!1&&(i[e]=function(){});var c=i[e];return c[n]=o.package,o.private.package=c,e in t==!1&&(t[e]={}),t[e][n]=o,r(e,n,a)},o=function(t,i,n){return void 0===n&&(n=i,i=t,t=e),r(t,i,n)},r=function(e,i,n){if(e in t!=!1&&i in t[e]!=!1){var a=!1,o=t[e][i],r=function(e,t){return function(){return e[t]}},c=function(e,t){return function(i){e[t]=i}},s=function(){return void 0},h=function(){throw new TypeError("Cannot set non-visible property")};for(var d in n)if(n.hasOwnProperty(d)){var g="private",u=d;if(0===u.indexOf("public ")?(g="public",u=u.substr(7)):0===u.indexOf("package ")?(g="package",u=u.substr(8)):0===u.indexOf("private ")&&(u=u.substr(8)),"function"==typeof n[d]){var v=n[d].bind(o.private);switch(g){case"private":o.private[u]=v;break;case"package":o.private[u]=v,o.package[u]=v;break;case"public":o.private[u]=v,o.package[u]=v,o.public[u]=v}"__constructor"===u&&(a=!0)}else switch(g){case"private":o.private[u]=n[d],Object.defineProperty(o.package,u,{get:s,set:h}),Object.defineProperty(o.public,u,{get:s,set:h});break;case"package":o.package[u]=n[d],Object.defineProperty(o.private,u,{get:r(o.package,u),set:c(o.package,u)}),Object.defineProperty(o.public,u,{get:s,set:h});break;case"public":o.public[u]=n[d],Object.defineProperty(o.private,u,{get:r(o.public,u),set:c(o.public,u)}),Object.defineProperty(o.package,u,{get:r(o.public,u),set:c(o.public,u)})}}return a===!0&&window.setTimeout(o.private.__constructor,0),o.public}};return{createSingleton:n,extendSingleton:o}}(),CWDebug=function(){var e=!0,t=function(){e=!0},i=function(){e=!1},n=function(t,i){e&&console.log(t+"|"+i)};return{enableDebug:t,disableDebug:i,log:n}}(),CWDeviceDiscoveryState={DISCOVERED:"discovered",LOST:"lost"},CWDeviceConnectionState={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected"};CWDevice.prototype.insert=function(e,t){Connichiwa.insert(this.getIdentifier(),e,t)},CWDevice.prototype.replace=function(e,t){Connichiwa.replace(this.getIdentifier(),e,t)},CWDevice.prototype.replaceContent=function(e,t){Connichiwa.replaceContent(this.getIdentifier(),e,t)},CWDevice.prototype.loadScript=function(e,t){Connichiwa.loadScript(this.getIdentifier(),e,t)},CWDevice.prototype.loadCSS=function(e){Connichiwa.loadCSS(this.getIdentifier(),e)},CWDevice.prototype.send=function(e,t){Connichiwa.send(this.getIdentifier(),e,t)},CWDevice.prototype.equalTo=function(e){return CWDevice.prototype.isPrototypeOf(e)===!1?!1:this.getIdentifier()===e.getIdentifier()},CWDevice.prototype.toString=function(){return this.getIdentifier()};var CWEventManager=function(){var e={},t=function(t,i){if("string"!=typeof t)throw"Event name must be a string";if("function"!=typeof i)throw"Event callback must be a function";if(t=t.toLowerCase(),-1===t.indexOf(" "))e[t]||(e[t]=[]),e[t].push(i),CWDebug.log(3,"Attached callback to "+t);else for(var n=t.split(" "),a=0;a<n.length;a++)CWEventManager.register(n[a],i)},i=function(t,i){var n=Array.prototype.slice.call(arguments);if(CWUtil.isString(t)===!0?(i=t,t=4,n.shift()):(n.shift(),n.shift()),i=i.toLowerCase(),!e[i])return void CWDebug.log(5,"No callbacks  for "+i+" registered");CWDebug.log(t,"Triggering event "+i+" for "+e[i].length+" callbacks");for(var a=0;a<e[i].length;a++){var o=e[i][a];o.apply(null,n)}};return{register:t,trigger:i}}();$(document).ready(function(){var e,t,i,n,a=!1,o=0;$("body").on("mousedown touchstart",function(t){e=CWUtil.getEventLocation(t,"client")}),$("body").on("mousemove touchmove",function(a){if(void 0!==e){var r=CWUtil.getEventLocation(a,"client");if(void 0!==t){var c=new CWVector(e,r),s=new CWVector(t,r),h=h||c.length()>5;if(h&&s.length()>1)if(void 0!==n){var d=s.angle(n);if(d>20){if(o++,3===o)return e=void 0,void(t=void 0)}else n=void 0,o=0}else if(void 0!==i){var g=s.angle(i);g>20&&(n=i,o=1)}s.length()>0&&(i=s)}t=r}}),$("body").on("mouseup touchend",function(){var r=e,c=t;if(e=void 0,t=void 0,i=void 0,a=!1,n=void 0,o=0,void 0!==r&&void 0!==c){var s=c.x-r.x,h=c.y-r.y,d=Math.sqrt(Math.pow(s,2)+Math.pow(h,2));if(10>=d)return void CWDebug.log(3,"Swipe REJECTED because it was too short ("+d+")");var g=.25;100>d&&(g=.35),50>d&&(g=.4),40>d&&(g=.45),15>d&&(g=.8);var u="invalid";Math.abs(h)<Math.abs(s)*g&&(s>0&&(u="right"),0>s&&(u="left")),Math.abs(s)<Math.abs(h)*g&&(h>0&&(u="down"),0>h&&(u="up"));var v=$(window).height()-window.innerHeight;c.y+=v;var l=c.y<=50,f=c.x<=50,p=c.y>=$(window).height()-50,C=c.x>=$(window).width()-50,b="invalid";if(l&&"up"===u&&(b="top"),f&&"left"===u&&(b="left"),p&&"down"===u&&(b="bottom"),C&&"right"===u&&(b="right"),"invalid"===b)return void CWDebug.log(3,"Swipe REJECTED. Ending: x - "+c.x+"/"+($(window).width()-50)+", y - "+c.y+"/"+($(window).height()-50)+". Direction: "+u+". Edge endings: "+l+", "+C+", "+p+", "+f);"top"===b&&(c.y=0),"left"===b&&(c.x=0),"bottom"===b&&(c.y=$(window).height()),"right"===b&&(c.x=$(window).width());var w={edge:b,x:c.x,y:c.y};CWEventManager.trigger("stitchswipe",w)}})});var CWGyroscope=OOP.createSingleton("Connichiwa","CWGyroscope",{_lastMeasure:void 0,__constructor:function(){gyro.frequency=500,gyro.startTracking(this._onUpdate)},"private _onUpdate":function(e){if(null!==e.alpha&&null!==e.beta&&null!==e.gamma&&null!==e.x&&null!==e.y&&null!==e.z){void 0===this._lastMeasure&&(this._lastMeasure=e);var t=e.alpha-this._lastMeasure.alpha,i=e.beta-this._lastMeasure.beta,n=e.gamma-this._lastMeasure.gamma,a={alpha:e.alpha,beta:e.beta,gamma:e.gamma,delta:{alpha:t,beta:i,gamma:n}};CWEventManager.trigger(5,"gyroscopeUpdate",a);var o=e.x-this._lastMeasure.x,r=e.y-this._lastMeasure.y,c=e.z-this._lastMeasure.z,s={x:e.x,y:e.y,z:e.z,delta:{x:o,y:r,z:c}};CWEventManager.trigger(5,"accelerometerUpdate",s),this._lastMeasure={x:e.x,y:e.y,z:e.z,alpha:e.alpha,beta:e.beta,gamma:e.gamma}}},"package getLastGyroscopeMeasure":function(){return void 0===this._lastMeasure?void 0:{alpha:this._lastMeasure.alpha,beta:this._lastMeasure.beta,gamma:this._lastMeasure.gamma}},"package getLastAccelerometerMeasure":function(){return void 0===this._lastMeasure?void 0:{x:this._lastMeasure.x,y:this._lastMeasure.y,z:this._lastMeasure.z}}});CWLocation.toGlobal=function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0);var a={x:e,y:t,width:i,height:n},o=CWStitchManager.getDeviceTransformation();return 0===o.rotation&&(a.y=t,a.x=e,a.width=i,a.height=n),90===o.rotation&&(a.y=o.height*o.scale-e-i,a.x=t,a.width=n,a.height=i),180===o.rotation&&(a.y=o.height*o.scale-t-n,a.x=o.width*o.scale-e-i,a.width=i,a.height=n),270===o.rotation&&(a.y=e,a.x=o.width*o.scale-t-n,a.width=n,a.height=i),a.x+=o.x*o.scale,a.y+=o.y*o.scale,a.x/=o.scale,a.y/=o.scale,a.width/=o.scale,a.height/=o.scale,a},CWLocation.toLocal=function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0);var a={x:e,y:t,width:i,height:n},o=CWStitchManager.getDeviceTransformation();return 0===o.rotation&&(a.y=t-o.y,a.x=e-o.x,a.width=i,a.height=n),90===o.rotation&&(a.y=e-o.x,a.x=o.height-(t-o.y+n),a.width=n,a.height=i),180===o.rotation&&(a.y=o.height-(t-o.y+n),a.x=o.width-(e-o.x+i),a.width=i,a.height=n),270===o.rotation&&(a.y=o.width-(e-o.x+i),a.x=t-o.y,a.width=n,a.height=i),a.x*=o.scale,a.y*=o.scale,a.width*=o.scale,a.height*=o.scale,a},CWLocation.applyRotation=function(e,t,i,n,a){var o=CWStitchManager.getDeviceTransformation();void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===a&&(a=o.rotation);var r={x:e,y:t,width:i,height:n};return 0===o.rotation&&(r.y=t,r.x=e,r.width=i,r.height=n),90===o.rotation&&(r.y=-e,r.x=t,r.width=n,r.height=i),180===o.rotation&&(r.y=-t,r.x=-e,r.width=i,r.height=n),270===o.rotation&&(r.y=e,r.x=-t,r.width=n,r.height=i),r},CWLocation.fromString=function(e){var t=JSON.parse(e);return new CWLocation(parseFloat(t.x),parseFloat(t.y),parseFloat(t.width),parseFloat(t.height),!1)};var CWStitchManager=OOP.createSingleton("Connichiwa","CWStitchManager",{"private _isStitched":!1,"private _deviceTransformation":void 0,"private _gyroDataOnStitch":void 0,"public unstitchOnMove":!0,"public ignoreMoveAxis":[],__constructor:function(){CWEventManager.register("stitchswipe",this._onLocalSwipe),CWEventManager.register("wasStitched",this._onWasStitched),CWEventManager.register("wasUnstitched",this._onWasUnstitched),CWEventManager.register("gyroscopeUpdate",this._onGyroUpdate),CWEventManager.register("accelerometerUpdate",this._onAccelerometerUpdate)},_onWasStitched:function(e){this._gyroDataOnStitch=this.package.CWGyroscope.getLastGyroscopeMeasure(),this._deviceTransformation=e.deviceTransformation,this._isStitched=!0},_onWasUnstitched:function(){this._gyroDataOnStitch=void 0,this._deviceTransformation=this.DEFAULT_DEVICE_TRANSFORMATION(),this._isStitched=!1},_onLocalSwipe:function(e){e.device=Connichiwa.getIdentifier(),e.width=CWSystemInfo.viewportWidth(),e.height=CWSystemInfo.viewportHeight(),Connichiwa.send("master","stitchswipe",e)},_onGyroUpdate:function(e){if(this.isStitched()!==!1&&this.unstitchOnMove!==!1){void 0===this._gyroDataOnStitch&&(this._gyroDataOnStitch=e);var t=Math.abs(e.alpha-this._gyroDataOnStitch.alpha),i=Math.abs(e.beta-this._gyroDataOnStitch.beta),n=Math.abs(e.gamma-this._gyroDataOnStitch.gamma);t=Math.abs((t+180)%360-180),i=Math.abs((i+180)%360-180),n=Math.abs((n+180)%360-180),(CWUtil.inArray("alpha",this.ignoreMoveAxis)===!1&&t>=35||CWUtil.inArray("beta",this.ignoreMoveAxis)===!1&&i>=20||CWUtil.inArray("gamma",this.ignoreMoveAxis)===!1&&n>=20)&&this._quitStitch()}},_onAccelerometerUpdate:function(e){if(this.isStitched()!==!1&&this.unstitchOnMove!==!1){var t=Math.abs(e.x),i=Math.abs(e.y),n=Math.abs(Math.abs(e.z)-9.81);(CWUtil.inArray("x",this.ignoreMoveAxis)===!1&&t>=1||CWUtil.inArray("y",this.ignoreMoveAxis)===!1&&i>=1||CWUtil.inArray("z",this.ignoreMoveAxis)===!1&&n>=1)&&this._quitStitch()}},"private _quitStitch":function(){var e={device:Connichiwa.getIdentifier()};Connichiwa.send("master","quitstitch",e)},"public unstitch":function(){this._quitStitch()},"public isStitched":function(){return this._isStitched},"public getDeviceTransformation":function(){return void 0===this._deviceTransformation?this.DEFAULT_DEVICE_TRANSFORMATION():this._deviceTransformation},"private DEFAULT_DEVICE_TRANSFORMATION":function(){return{x:0,y:0,width:CWSystemInfo.viewportWidth(),height:CWSystemInfo.viewportHeight(),rotation:0,scale:1}}}),CWSystemInfo=OOP.createSingleton("Connichiwa","CWSystemInfo",{_ppi:void 0,"public PPI":function(){return void 0!==this._ppi?this._ppi:(this._ppi=this.DEFAULT_PPI(),window.devicePixelRatio>1&&(this._ppi=142),"iPad"===navigator.platform&&(this._ppi=132),("iPhone"===navigator.platform||"iPod"===navigator.platform)&&(this._ppi=3===window.devicePixelRatio?153:163),this._ppi)},"public isLandscape":function(){return window.innerHeight<window.innerWidth},"public viewportWidth":function(){return $(window).width()},"public viewportHeight":function(){return $(window).height()},"public DEFAULT_PPI":function(){return 100}}),CWUtil=function(){var e=function(e){var t=document.createElement("a");return t.href=e,t},t=function(e,t){void 0===t&&(t="page");var i={x:e[t+"X"],y:e[t+"Y"]};return(void 0===i.x||void 0===i.y)&&(i={x:e.originalEvent.targetTouches[0][t+"X"],y:e.originalEvent.targetTouches[0][t+"Y"]}),i},i=function(e,t){return void 0===t&&void 0!==e?(t=e,e=0):void 0===t&&void 0===e&&(e=0,t=Number.MAX_VALUE),Math.floor(Math.random()*(t-e+1))+e},n=function(e){return e===parseInt(e)},a=function(e){return"string"==typeof e},o=function(e){return"object"==typeof e&&null!==e},r=function(e,t){return t.indexOf(e)>-1},c=function(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,CWUtil.createUUID)};return{parseURL:e,getEventLocation:t,randomInt:i,isInt:n,isString:a,isObject:o,inArray:r,createUUID:c}}();CWVector.prototype.angle=function(e){var t=this.deltaX()*e.deltaX()+this.deltaY()*e.deltaY(),i=this.length()*e.length();return Math.acos(t/i)*(180/Math.PI)};var CWWebsocketMessageParser=OOP.createSingleton("Connichiwa","CWWebsocketMessageParser",{"package parse":function(e){switch(e._name){case"ack":this._parseAck(e);break;case"_insert":this._parseInsert(e);break;case"_replace":this._parseReplace(e);break;case"loadscript":this._parseLoadScript(e);break;case"_loadcss":this._parseLoadCSS(e);break;case"wasstitched":this._parseWasStitched(e);break;case"wasunstitched":this._parseWasUnstitched(e);break;case"gotstitchneighbor":this._parseGotStitchNeighbor(e);break;case"remotelog":this._parseRemoteLog(e)}},_parseAck:function(e){CWEventManager.trigger("__messageack__id"+e.original._id)},_parseInsert:function(e){$(e.selector).append(e.html)},_parseReplace:function(e){e.contentOnly===!0?$(e.selector).html(e.html):$(e.selector).replaceWith(e.html)},_parseLoadScript:function(e){var t=this;$.getScript(e.url).done(function(){t.package.Connichiwa._sendAck(e)}).fail(function(t,i,n){CWDebug.log(1,"There was an error loading '"+e.url+"': "+n)})},_parseLoadCSS:function(e){var t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e.url),$("head").append(t),this.package.Connichiwa._sendAck(e)},_parseWasStitched:function(e){CWEventManager.trigger("wasStitched",e)},_parseWasUnstitched:function(e){CWEventManager.trigger("wasUnstitched",e)},_parseGotStitchNeighbor:function(e){CWEventManager.trigger("gotstitchneighbor",e)},_parseRemoteLog:function(e){CWDebug.log(e.priority,"(From "+e._source+") "+e.message)}}),Connichiwa=OOP.createSingleton("Connichiwa","Connichiwa",{"private _websocket":void 0,"public getIdentifier":function(){},"public isMaster":function(){},"public on":function(e,t){return"load"===e?void this.onLoad(t):void CWEventManager.register(e,t)},"public onMessage":function(e,t){this.on("message"+e,t)},"public onLoad":function(e){"complete"===document.readyState?e():Connichiwa.on("ready",e)},"public insert":function(e,t,i){if(void 0===i&&(i=t,t="body"),CWUtil.isObject(t)&&(t="#"+$(t).attr("id")),CWUtil.isObject(i)===!0){var n=$(i),a=n.clone();a[0].style.cssText=n[0].style.cssText,i=a[0].outerHTML}CWDevice.prototype.isPrototypeOf(e)&&(e=e.getIdentifier());var o={selector:t,html:i};this.send(e,"_insert",o)},"public replace":function(e,t,i){void 0===i&&(i=t,t="body"),this._replace(e,t,i,!1)},"public replaceContent":function(e,t,i){void 0===i&&(i=t,t="body"),this._replace(e,t,i,!0)},"private _replace":function(e,t,i,n){if(void 0===i&&(i=t,t="body"),CWUtil.isObject(t)&&(t="#"+$(t).attr("id")),CWUtil.isObject(i)===!0){var a=$(i),o=a.clone();o[0].style.cssText=a[0].style.cssText,i=o[0].outerHTML}CWDevice.prototype.isPrototypeOf(e)&&(e=e.getIdentifier());var r={selector:t,html:i,contentOnly:n};this.send(e,"_replace",r)},"public loadScript":function(e,t,i){var n={url:t},a=this.send(e,"loadscript",n);void 0!==i&&this.on("__messageack__id"+a,i)},"public loadCSS":function(e,t){{var i={url:t};this.send(e,"_loadcss",i)}},"public send":function(e,t,i){return void 0===i&&(i=e,e="master"),CWDevice.prototype.isPrototypeOf(e)&&(e=e.getIdentifier()),i._name=t,i._source=this.getIdentifier(),i._target=e,this._sendObject(i)},"public respond":function(e,t,i){this.send(e._source,t,i)},"public broadcast":function(e,t,i){this.send("broadcast",e,t),i===!0&&this.send(this.getIdentifier(),e,t)},"package _sendAck":function(e){var t={original:e};this.send(e._source,"ack",t)},"package _sendObject":function(e){"_name"in e==!1&&console.warn("Tried to send message without _name, ignoring: "+JSON.stringify(e)),e._id=CWUtil.randomInt(),e._name=e._name.toLowerCase();var t=JSON.stringify(e);return CWDebug.log(4,"Sending message: "+t),this._websocket.send(t),e._id},"package _disconnectWebsocket":function(){this._websocket.close()},_cleanupWebsocket:function(){void 0!==this._websocket&&(this._websocket.onopen=void 0,this._websocket.onmessage=void 0,this._websocket.onclose=void 0,this._websocket.onerror=void 0,this._websocket=void 0)}});CWDevice.prototype.connect=function(){this.canBeConnected()!==!1&&(this.connectionState=CWDeviceConnectionState.CONNECTING,nativeCallConnectRemote(this.getIdentifier()))};var CWDeviceManager=function(){var e,t=[],i=function(e){if(CWDevice.prototype.isPrototypeOf(e)===!1)throw"Cannot add a non-device";return null!==a(e.getIdentifier())?!1:(CWDebug.log(3,"Added device: "+e.getIdentifier()),t.push(e),!0)},n=function(e){CWDevice.prototype.isPrototypeOf(e)===!0&&(e=e.getIdentifier());var i=a(e);if(null===i)return!1;CWDebug.log("Removed device: "+e);var n=t.indexOf(i);return t.splice(n,1),!0},a=function(i){if(void 0!==e&&(i===e.getIdentifier()||"master"===i))return e;for(var n=0;n<t.length;n++){var a=t[n];if(a.getIdentifier()===i)return a}return null},o=function(){for(var e=[],i=0;i<t.length;i++){var n=t[i];n.isConnected()&&e.push(n)}return e},r=function(t){return void 0!==e?!1:(t.isLocal=!0,e=new CWDevice(t),e.discoveryState=CWDeviceDiscoveryState.LOST,e.connectionState=CWDeviceConnectionState.CONNECTED,CWDebug.log(3,"Created local device: "+JSON.stringify(t)),!0)},c=function(){return e};return{addDevice:i,removeDevice:n,getDeviceWithIdentifier:a,getConnectedDevices:o,createLocalDevice:r,getLocalDevice:c}}(),CWNativeMasterCommunication=OOP.createSingleton("Connichiwa","CWNativeMasterCommunication",{"public callOnNative":function(e){if(this.isRunningNative()===!0){var t=Array.prototype.slice.call(arguments);t.shift();var i=window[e];"function"==typeof i?i.apply(null,t):CWDebug.log(1,"ERROR: Tried to call native method with name "+e+", but it doesn't exist!")}},"public parse":function(e){CWDebug.log(4,"Parsing native message (master): "+e);var t=JSON.parse(e);switch(t._name){case"cwdebug":this._parseDebug(t);break;case"connectwebsocket":this._parseConnectWebsocket(t);break;case"localinfo":this._parseLocalInfo(t);break;case"devicedetected":this._parseDeviceDetected(t);break;case"devicedistancechanged":this._parseDeviceDistanceChanged(t);break;case"devicelost":this._parseDeviceLost(t);break;case"remoteconnectfailed":this._parseRemoteConnectFailed(t);break;case"remotedisconnected":this._parseRemoteDisconnected(t);break;case"disconnectwebsocket":this._parseDisconnectWebsocket(t)}},_parseDebug:function(e){e.cwdebug===!0?CWDebug.enableDebug():CWDebug.disableDebug()},_parseConnectWebsocket:function(){this.package.Connichiwa._connectWebsocket()},_parseLocalInfo:function(e){var t=CWDeviceManager.createLocalDevice(e);t&&(this.package.Connichiwa._sendObject(e),CWEventManager.trigger("ready"))},_parseDeviceDetected:function(e){var t=CWDeviceManager.getDeviceWithIdentifier(e.identifier);if(null===t&&(t=new CWDevice(e),CWDeviceManager.addDevice(t)),t.discoveryState=CWDeviceDiscoveryState.DISCOVERED,CWDebug.log(2,"Detected device: "+t.getIdentifier()),CWEventManager.trigger("deviceDetected",t),Connichiwa.autoConnect===!0){var i=CWDeviceManager.getLocalDevice();i.getLaunchDate()<t.getLaunchDate()&&t.connect()}},_parseDeviceDistanceChanged:function(e){var t=CWDeviceManager.getDeviceWithIdentifier(e.identifier);null!==t&&(t.distance=e.distance,CWDebug.log(5,"Updated distance of device "+t.getIdentifier()+" to "+t.distance),CWEventManager.trigger("deviceDistanceChanged",t))},_parseDeviceLost:function(e){var t=CWDeviceManager.getDeviceWithIdentifier(e.identifier);t.discoveryState=CWDeviceDiscoveryState.LOST,CWDebug.log(2,"Lost device: "+t.getIdentifier()),CWEventManager.trigger("deviceLost",t)},_parseRemoteConnectFailed:function(e){var t=CWDeviceManager.getDeviceWithIdentifier(e.identifier);t.connectionState=CWDeviceConnectionState.DISCONNECTED,CWDebug.log(2,"Connection to remote device failed: "+t.getIdentifier()),CWEventManager.trigger("connectFailed",t)},_parseRemoteDisconnected:function(e){var t=CWDeviceManager.getDeviceWithIdentifier(e.identifier);null!==t&&(t.connectionState=CWDeviceConnectionState.DISCONNECTED,CWDebug.log(2,"Device disconnected: "+t.getIdentifier()),CWEventManager.trigger("deviceDisconnected",t))},_parseDisconnectWebsocket:function(){this.package.Connichiwa._disconnectWebsocket()}});OOP.extendSingleton("Connichiwa","CWStitchManager",{"private _swipes":{},"private _devices":{},"public getDeviceTransformation":function(e,t){if(void 0===e&&(e=Connichiwa.getIdentifier()),CWDevice.prototype.isPrototypeOf(e)&&(e=e.getIdentifier()),void 0===t&&(t=!1),e===Connichiwa.getIdentifier()&&t!==!0)return void 0===this._deviceTransformation?this.DEFAULT_DEVICE_TRANSFORMATION():this._deviceTransformation;var i=this._getStitchData(e);return void 0===i?this.DEFAULT_DEVICE_TRANSFORMATION():{width:i.width,height:i.height,x:i.transformX,y:i.transformY,rotation:i.rotation,scale:i.scale}},"package detectedSwipe":function(e){var t={date:new Date,device:e.device,edge:e.edge,width:e.width,height:e.height,x:e.x,y:e.y},i=CWDeviceManager.getDeviceWithIdentifier(t.device);if(null!==i&&i.isConnected()!==!1){CWDebug.log(3,"Detected swipe on "+t.device+" on edge "+t.edge);for(var n in this._swipes){var a=this._swipes[n];if(CWDebug.log(4,"Checking existing swipe: "+n),a.device!==t.device&&(CWDebug.log(4,"Checking time constraint"),!(t.date.getTime()-a.date.getTime()>1e3))){CWDebug.log(4,"Checking connection constraint");var o=CWDeviceManager.getDeviceWithIdentifier(a.device);if(null!==o&&o.isConnected()!==!1)return void this._detectedStitch(a,t)}}this._swipes[t.device]=t}},"package unstitchDevice":function(e){if(e in this._devices){var t={deviceTransformation:this.getDeviceTransformation(e)};Connichiwa.send(e,"wasunstitched",t),delete this._devices[e],CWDebug.log(3,"Device was unstitched: "+e)}},"private _detectedStitch":function(e,t){function i(e,t){var i={};return 0===t&&(i.y=e.y,i.x=e.x,i.width=e.width,i.height=e.height),90===t&&(i.y=e.width-e.x,i.x=e.y,i.width=e.height,i.height=e.width),180===t&&(i.y=e.height-e.y,i.x=e.width-e.x,i.width=e.width,i.height=e.height),270===t&&(i.y=e.x,i.x=e.height-e.y,i.width=e.height,i.height=e.width),i}if(0===Object.keys(this._devices).length){if(t.device===Connichiwa.getIdentifier()){var n=e;e=t,t=n}var a=this._createStitchData(e.device);a.width=e.width,a.height=e.height,this._devices[e.device]=a,CWDebug.log(3,"First device was auto-stitched: "+JSON.stringify(a)),CWEventManager.trigger("stitch",t.device,e.device);var o={otherDevice:t.device,edge:e.edge,deviceTransformation:this.getDeviceTransformation(e.device,!0)};Connichiwa.send(e.device,"wasstitched",o)}var r=this._getStitchData(e.device),c=this._getStitchData(t.device);if(!(void 0===r&&void 0===c||void 0!==r&&void 0!==c)){var s,h;void 0!==r?(s=e,h=t):(s=t,h=e);var d=CWDeviceManager.getDeviceWithIdentifier(s.device),g=CWDeviceManager.getDeviceWithIdentifier(h.device),u=this._getStitchData(s.device),v=this._createStitchData(h.device);v.scale=g.getPPI()/d.getPPI()*u.scale;var l=0,f=this._indexForEdge(s.edge)-this._indexForEdge(h.edge);0>f&&(f+=4),2===f&&(l=0),3===f&&(l=90),1===f&&(l=270),0===f&&(l=180),v.rotation=(l+u.rotation)%360;var p=i(h,v.rotation);p.edge=(this._indexForEdge(h.edge)+v.rotation/90)%4,p.y/=v.scale,p.x/=v.scale,p.width/=v.scale,p.height/=v.scale;var C=i(s,u.rotation);C.edge=(this._indexForEdge(s.edge)+u.rotation/90)%4,C.y/=u.scale,C.x/=u.scale,C.width/=u.scale,C.height/=u.scale,v.width=p.width,v.height=p.height,v.deviceWidth=h.width,v.deviceHeight=h.height,v.transformX=u.transformX+C.x-p.x,v.transformY=u.transformY+C.y-p.y,this._devices[h.device]=v,CWDebug.log(3,"Device was stitched: "+JSON.stringify(v)),CWEventManager.trigger("stitch",s.device,h.device);var o={otherDevice:s.device,edge:h.edge,deviceTransformation:this.getDeviceTransformation(h.device,!0)};g.send("wasstitched",o);var b={otherDevice:h.device,edge:s.edge};d.send("gotstitchneighbor",b)}},"private _createStitchData":function(e){return{device:e,width:0,height:0,transformX:0,transformY:0,rotation:0,scale:1}},"private _getStitchData":function(e){return CWDevice.prototype.isPrototypeOf(e)&&(e=e.getIdentifier()),this._devices[e]},"private _coordinateForEdge":function(e,t){var i=this._axisForEdge(e);return null===i?null:t[i]},"private _axisForEdge":function(e){return"left"===e||"right"===e?"y":"top"===e||"bottom"===e?"x":null},"private _invertAxis":function(e){return"x"===e?"y":"y"===e?"x":null},"private _oppositeEdge":function(e){switch(e){case"top":return"bottom";case"bottom":return"top";case"left":return"right";case"right":return"left"}return"invalid"},"private _indexForEdge":function(e){switch(e){case"top":return 0;case"bottom":return 2;case"left":return 1;case"right":return 3}return-1},"private _edgeForIndex":function(e){switch(e){case 0:return"top";case 2:return"bottom";case 3:return"right";case 1:return"left"}return"invalid"}}),OOP.extendSingleton("Connichiwa","CWWebsocketMessageParser",{"package parseOnMaster":function(e){switch(e._name){case"remoteinfo":this._parseRemoteInfo(e);break;case"stitchswipe":this._parseStitchSwipe(e);break;case"quitstitch":this._parseQuitStitch(e)}},_parseRemoteInfo:function(e){var t=CWDeviceManager.getDeviceWithIdentifier(e.identifier);null===t?(t=new CWDevice(e),CWDeviceManager.addDevice(t)):CWDebug.log(1,"TODO"),t.connectionState=CWDeviceConnectionState.CONNECTED,nativeCallRemoteDidConnect(t.getIdentifier());for(var i=function(){CWEventManager.trigger("deviceConnected",t)},n=function(e,t){var i=t.split(".").pop().toLowerCase();"css"===i&&e.loadCSS(t)},a=[],o=[],r=0;r<Connichiwa.autoLoad.length;r++){var c=Connichiwa.autoLoad[r],s=c.split(".").pop().toLowerCase();"js"===s?a.push(c):o.push(c)}for(var r=0;r<o.length;r++){var c=o[r];n(t,c)}if(a.lenth>0)for(var r=0;r<a.length;r++){var h=a[r];r===a.length-1?t.loadScript(h,i):t.loadScript(h)}else i()},_parseStitchSwipe:function(e){this.package.CWStitchManager.detectedSwipe(e)},_parseQuitStitch:function(e){this.package.CWStitchManager.unstitchDevice(e.device)}}),OOP.extendSingleton("Connichiwa","Connichiwa",{"private _connectionAttempts":0,"public autoConnect":!1,"public autoLoad":[],"public getIdentifier":function(){var e=CWDeviceManager.getLocalDevice();return void 0===e?void 0:e.getIdentifier()},"public isMaster":function(){return!0},"public getIPs":function(){var e=CWDeviceManager.getLocalDevice();return void 0===e?void 0:e.getIPs()},"public getPort":function(){var e=CWDeviceManager.getLocalDevice();return void 0===e?void 0:e.getPort()},"package _connectWebsocket":function(){(void 0===this._websocket||this._websocket.state!==CONNECTING&&this._websocket.state!==OPEN)&&(this._cleanupWebsocket(),CWDebug.log(3,"Connecting websocket"),this._websocket=new WebSocket("ws://127.0.0.1:8001"),this._websocket.onopen=this._onWebsocketOpen,this._websocket.onmessage=this._onWebsocketMessage,this._websocket.onclose=this._onWebsocketClose,this._websocket.onerror=this._onWebsocketError,this._connectionAttempts++)},_onWebsocketOpen:function(){CWDebug.log(3,"Websocket opened"),nativeCallWebsocketDidOpen(),this._connectionAttempts=0},_onWebsocketMessage:function(e){var t=JSON.parse(e.data);CWDebug.log(4,"Received message: "+e.data);var i=this;window.requestAnimationFrame(function(){i.package.CWWebsocketMessageParser.parse(t),i.package.CWWebsocketMessageParser.parseOnMaster(t),t._name&&CWEventManager.trigger("message"+t._name,t)})},_onWebsocketClose:function(){return CWDebug.log(3,"Websocket closed"),this._cleanupWebsocket(),this._connectionAttempts>=5?void nativeCallWebsocketDidClose():void setTimeout(function(){this._connectWebsocket()},1e3*this._connectionAttempts)},_onWebsocketError:function(){this._onWebsocketClose()}});
//# sourceMappingURL=connichiwa.min.js.map