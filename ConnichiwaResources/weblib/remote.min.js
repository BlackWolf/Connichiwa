"use strict";var OOP=function(){var DEFAULT_PACKAGE_NAME="default",classes={},packages={},createSingleton=function(packageName,className,properties){return void 0===properties&&(properties=className,className=packageName,packageName=DEFAULT_PACKAGE_NAME),_createSingletonInPackage(packageName,className,properties)},_createSingletonInPackage=function(packageName,className,properties){var theClass={"private":function(){},"package":function(){},"public":function(){}};packageName in packages==!1&&(packages[packageName]=function(){});var thePackage=packages[packageName];return thePackage[className]=theClass.package,theClass.private.package=thePackage,packageName in classes==!1&&(classes[packageName]={}),classes[packageName][className]=theClass,_extendSingletonInPackage(packageName,className,properties)},extendSingleton=function(packageName,className,properties){return void 0===properties&&(properties=className,className=packageName,packageName=DEFAULT_PACKAGE_NAME),_extendSingletonInPackage(packageName,className,properties)},_extendSingletonInPackage=function(packageName,className,properties){if(packageName in classes!=!1&&className in classes[packageName]!=!1){var theClass=classes[packageName][className],getter=function(scope,propertyName){return function(){return scope[propertyName]}},setter=function(scope,propertyName){return function(value){scope[propertyName]=value}},errorGetter=function(){return void 0},errorSetter=function(){throw new TypeError("Cannot set non-visible property")};for(var modifiedPropertyName in properties)if(properties.hasOwnProperty(modifiedPropertyName)){var visibility="private",propertyName=modifiedPropertyName;if(0===propertyName.indexOf("public ")?(visibility="public",propertyName=propertyName.substr(7)):0===propertyName.indexOf("package ")?(visibility="package",propertyName=propertyName.substr(8)):0===propertyName.indexOf("private ")&&(propertyName=propertyName.substr(8)),"function"==typeof properties[modifiedPropertyName]){var theMethod=properties[modifiedPropertyName].bind(theClass.private);switch(visibility){case"private":theClass.private[propertyName]=theMethod;break;case"package":theClass.private[propertyName]=theMethod,theClass.package[propertyName]=theMethod;break;case"public":theClass.private[propertyName]=theMethod,theClass.package[propertyName]=theMethod,theClass.public[propertyName]=theMethod}}else switch(visibility){case"private":theClass.private[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.package,propertyName,{get:errorGetter,set:errorSetter}),Object.defineProperty(theClass.public,propertyName,{get:errorGetter,set:errorSetter});break;case"package":theClass.package[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.private,propertyName,{get:getter(theClass.package,propertyName),set:setter(theClass.package,propertyName)}),Object.defineProperty(theClass.public,propertyName,{get:errorGetter,set:errorSetter});break;case"public":theClass.public[propertyName]=properties[modifiedPropertyName],Object.defineProperty(theClass.private,propertyName,{get:getter(theClass.public,propertyName),set:setter(theClass.public,propertyName)}),Object.defineProperty(theClass.package,propertyName,{get:getter(theClass.public,propertyName),set:setter(theClass.public,propertyName)})}}return theClass.public}};return{createSingleton:createSingleton,extendSingleton:extendSingleton}}(),CWDebug=function(){var debug=!1,enableDebug=function(){debug=!0},log=function(priority,message){debug&&console.log(priority+"|"+message)};return{enableDebug:enableDebug,log:log}}(),CWEventManager=function(){var _events={},register=function(event,callback){if("string"!=typeof event)throw"Event name must be a string";if("function"!=typeof callback)throw"Event callback must be a function";_events[event]||(_events[event]=[]),_events[event].push(callback),CWDebug.log(3,"Attached callback to "+event)},trigger=function(event){if(CWDebug.log(4,"Triggering event "+event),!_events[event])return CWDebug.log(1,"No callbacks registered"),void 0;var args=Array.prototype.slice.call(arguments);args.shift();for(var i=0;_events[event].length>i;i++){var callback=_events[event][i];callback.apply(null,args)}};return{register:register,trigger:trigger}}();$(document).ready(function(){var startLocation,endLocation;$("body").on("mousedown touchstart",function(e){startLocation=CWUtil.getEventLocation(e,"client")}),$("body").on("mousemove touchmove",function(e){void 0!==startLocation&&(endLocation=CWUtil.getEventLocation(e,"client"))}),$("body").on("mouseup touchend",function(){var swipeStart=startLocation,swipeEnd=endLocation;if(startLocation=void 0,endLocation=void 0,void 0!==swipeStart&&void 0!==swipeEnd){var deltaX=swipeEnd.x-swipeStart.x,deltaY=swipeEnd.y-swipeStart.y,swipeLength=Math.sqrt(Math.pow(deltaX,2)+Math.pow(deltaY,2));if(CWDebug.log(1,"Swipe length is "+swipeLength),!(10>=swipeLength)){var xyRatio=.25;100>swipeLength&&(xyRatio=.35),50>swipeLength&&(xyRatio=.4),40>swipeLength&&(xyRatio=.45),15>swipeLength&&(xyRatio=.8);var direction="invalid";Math.abs(deltaY)<Math.abs(deltaX)*xyRatio&&(deltaX>0&&(direction="right"),0>deltaX&&(direction="left")),Math.abs(deltaX)<Math.abs(deltaY)*xyRatio&&(deltaY>0&&(direction="down"),0>deltaY&&(direction="up")),CWDebug.log(1,"deltaX "+deltaX+", deltaY "+deltaY),CWDebug.log(1,"swipe direction is "+direction);var endsAtTopEdge=50>=swipeEnd.y,endsAtLeftEdge=50>=swipeEnd.x,endsAtBottomEdge=swipeEnd.y>=screen.availHeight-50,endsAtRightEdge=swipeEnd.x>=screen.availWidth-50,edge="invalid";if(endsAtTopEdge&&"up"===direction&&(edge="top"),endsAtLeftEdge&&"left"===direction&&(edge="left"),endsAtBottomEdge&&"down"===direction&&(edge="bottom"),endsAtRightEdge&&"right"===direction&&(edge="right"),"invalid"!==edge){var message={type:"pinchswipe",device:Connichiwa.getIdentifier(),edge:edge,width:screen.availWidth,height:screen.availHeight,x:swipeEnd.x,y:swipeEnd.y};Connichiwa.send(message)}}}})});var CWUtil=function(){var parseURL=function(url){var parser=document.createElement("a");return parser.href=url,parser},getEventLocation=function(e,type){void 0===type&&(type="page");var pos={x:e[type+"X"],y:e[type+"Y"]};return(void 0===pos.x||void 0===pos.y)&&(pos={x:e.originalEvent.targetTouches[0][type+"X"],y:e.originalEvent.targetTouches[0][type+"Y"]}),pos},isInt=function(value){return value===parseInt(value)},isObject=function(value){return"object"==typeof value&&null!==value},inArray=function(value,array){return array.indexOf(value)>-1};return{parseURL:parseURL,getEventLocation:getEventLocation,isInt:isInt,isObject:isObject,inArray:inArray}}(),Connichiwa=OOP.createSingleton("Connichiwa","Connichiwa",{"private _identifier":void 0,"private _websocket":void 0,"public getIdentifier":function(){return this._identifier},"package _setIdentifier":function(value){return void 0!==this._identifier?!1:(this._identifier=value,CWDebug.log(2,"Identifier set to "+this._identifier),!0)},"public onMessage":function(type,callback){CWEventManager.register("message"+type,callback)},"package _disconnectWebsocket":function(){this._websocket.close()},"package _sendObject":function(messageObject){this._send(JSON.stringify(messageObject))},"package _send":function(message){CWDebug.log(4,"Sending message: "+message),this._websocket.send(message)},_cleanupWebsocket:function(){void 0!==this._websocket&&(this._websocket.onopen=void 0,this._websocket.onmessage=void 0,this._websocket.onclose=void 0,this._websocket.onerror=void 0,this._websocket=void 0)}}),CWMasterCommunication=OOP.createSingleton("Connichiwa","CWMasterCommunication",{"public parse":function(message){if("softdisconnect"===message.type&&this.package.Connichiwa._softDisconnectWebsocket(),"show"===message.type&&$("body").append(message.content),"update"===message.type&&$(message.element).html(message.content),"beginPath"===message.type){var context=$(message.element)[0].getContext("2d");context.beginPath(),context.moveTo(message.coords.x,message.coords.y)}if("updatePath"===message.type){var context=$(message.element)[0].getContext("2d");context.lineTo(message.coords.x,message.coords.y),context.stroke()}if("endPath"===message.type){var context=$(message.element)[0].getContext("2d");context.closePath()}"loadScript"===message.type&&(CWDebug.log(1,"LOADING SCRIPT "+message.url),$.getScript(message.url).done(function(){CWDebug.log(1,"SCRIPT WAS LOADED");var message={type:"scriptLoaded",request:message};Connichiwa.send(message)}).fail(function(f,s,t){CWDebug.log(1,"SCRIPT LOAD FAILED HARD: "+t)}))}}),CWNativeRemoteCommunication=OOP.createSingleton("Connichiwa","CWNativeRemoteCommunication",{"public parse":function(message){CWDebug.log(4,"Parsing native message (remote): "+message);var object=JSON.parse(message);switch(object.type){case"connectwebsocket":this._parseConnectWebsocket(object);break;case"cwdebug":this._parseDebug(object);break;case"remoteidentifier":this._parseRemoteIdentifier(object);break;case"disconnectwebsocket":this._parseDisconnectWebsocket(object)}},_parseConnectWebsocket:function(){this.package.Connichiwa._connectWebsocket()},_parseDebug:function(){CWDebug.enableDebug()},_parseRemoteIdentifier:function(message){this.package.Connichiwa._setIdentifier(message.identifier);var data={type:"remoteidentifier",identifier:message.identifier};this.package.Connichiwa.send(data)},_parseDisconnectWebsocket:function(){this.package.Connichiwa._disconnectWebsocket()}});OOP.extendSingleton("Connichiwa","Connichiwa",{"private _parsedURL":new CWUtil.parseURL(document.URL),"private _softDisconnected":!1,"public isMaster":function(){return!1},"public send":function(identifier,messageObject){return"broadcast"===identifier?(this.broadcast(messageObject),void 0):void 0===messageObject?(messageObject=identifier,identifier=void 0,messageObject.source=this.getIdentifier(),messageObject.target="master",this._sendObject(messageObject),void 0):(messageObject.source=this.getIdentifier(),messageObject.target=identifier,this._sendObject(messageObject),void 0)},"public broadcast":function(messageObject){messageObject.source=this.getIdentifier(),messageObject.target="broadcast",this._sendObject(messageObject)},"package _connectWebsocket":function(){var oldWebsocket=this._websocket;this._cleanupWebsocket(),void 0!==oldWebsocket&&oldWebsocket.close(),this._websocket=new WebSocket("ws://"+this._parsedURL.hostname+":"+(parseInt(this._parsedURL.port)+1)),this._websocket.onopen=this._onWebsocketOpen,this._websocket.onmessage=this._onWebsocketMessage,this._websocket.onclose=this._onWebsocketClose,this._websocket.onerror=this._onWebsocketError},_softDisconnectWebsocket:function(){this._softDisconnected=!0,nativeCallSoftDisconnect()},_onWebsocketOpen:function(){CWDebug.log(3,"Websocket opened"),this._softDisconnected=!1,nativeCallWebsocketDidOpen()},_onWebsocketMessage:function(e){var message=JSON.parse(e.data);CWDebug.log(4,"Received message: "+e.data),window.requestAnimationFrame(function(){CWMasterCommunication.parse(message),message.type&&CWEventManager.trigger("message"+message.type,message)})},_onWebsocketClose:function(){CWDebug.log(3,"Websocket closed"),this._cleanupWebsocket(),nativeCallWebsocketDidClose()},_onWebsocketError:function(){this._onWebsocketClose()}}),CWEventManager.trigger("ready");