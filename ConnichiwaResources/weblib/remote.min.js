"use strict";function CWDevice(t){if(!t.identifier)throw"Cannot instantiate CWDevice without an identifier";this._identifier=t.identifier,this._discoveryState=CWDevice.DiscoveryState.LOST,this._connectionState=CWDevice.ConnectionState.DISCONNECTED,this._distance=-1,this._launchDate=Date.now()/1e3,this._ips=[],this._port=void 0,this._name="remote device",this._ppi=CWSystemInfo.DEFAULT_PPI,this._setProperties(t)}function CWLocation(t,e,i,o,n){if(void 0===n&&(n=!0),this._x=void 0,this._y=void 0,this._width=void 0,this._height=void 0,n===!0){var a=CWLocation._toGlobal(t,e,i,o);this._x=a.x,this._y=a.y,this._width=a.width,this._height=a.height}else this._x=t,this._y=e,this._width=i,this._height=o;CWEventManager.register("wasUnstitched",function(t){this._x-=t.deviceTransformation.x,this._y-=t.deviceTransformation.y,this._x*=t.deviceTransformation.scale,this._y*=t.deviceTransformation.scale,this._width*=t.deviceTransformation.scale,this._height*=t.deviceTransformation.scale}.bind(this)),CWEventManager.register("wasStitched",function(t){this._x/=t.deviceTransformation.scale,this._y/=t.deviceTransformation.scale,this._width/=t.deviceTransformation.scale,this._height/=t.deviceTransformation.scale,this._x+=t.deviceTransformation.x,this._y+=t.deviceTransformation.y}.bind(this))}function CWVector(t,e){if(void 0===t||void 0===e)throw"Cannot instantiate Vector without 2 points";this._p1=t,this._p2=e}var CWModules={};CWModules._modules={},CWModules._didInit=!1,CWModules.retrieve=function(t){return t in this._modules==!1&&(this._modules[t]={}),this._modules[t]}.bind(CWModules),CWModules.init=function(){if(this._didInit)throw"Cannot initialize modules twice";var t=this;window.setTimeout(function(){for(var e in t._modules)if(t._modules.hasOwnProperty(e)){console.log("Initializing module "+e+"...");var i=t._modules[e];for(var o in i)i.hasOwnProperty(o)&&"function"==typeof i[o]&&(i[o]=i[o].bind(i));i.__constructor&&i.__constructor()}CWNativeBridge.callOnNative("nativeCallLibraryDidLoad")},0),this._didInit=!0}.bind(CWModules);var CWDatastore=CWModules.retrieve("CWDatastore");CWDatastore._data={},CWDatastore.set=function(t,e,i){var o={};o[e]=i,this.setMultiple(t,o)},CWDatastore.setMultiple=function(t,e){void 0===e&&(e=t,t=void 0),void 0===t&&(t="_default"),this._set(t,e,!0)},CWDatastore._set=function(t,e,i){t in this._data==!1&&(this._data[t]={});var o=this,n={};$.each(e,function(e,i){if(CWUtil.isFunction(i))return CWDebug.err("Attempted to store function in CWDatastore (collection: "+t+", key: "+e+"). This is invalid and will be ignored."),!0;var a=o._data[t][e];o._data[t][e]=i,n[e]={old:a,new:i}}),i&&this._syncEntrys(t,Object.keys(n));var a="_default"===t?void 0:t;CWEventManager.trigger("_datastorechanged",a,n)},CWDatastore.get=function(t,e){return void 0===e&&(e=t,t="_default"),t in this._data==!1||e in this._data[t]==!1?void 0:this._data[t][e]},CWDatastore.getCollection=function(t){return this._getCollection(t,!0)},CWDatastore._getCollection=function(t,e){return void 0===t&&(t="_default"),void 0===e&&(e=!0),t in this._data==!1&&(this._data[t]={}),e===!1?this._data[t]:$.extend(!0,{},this._data[t])},CWDatastore._syncEntrys=function(t,e){var i={};i[t]={},CWUtil.isArray(e)===!1&&(e=[e]);var o=this;$.each(e,function(e,n){var a=o.get(t,n);void 0!==a&&(i[t][n]=a)}),Connichiwa.broadcast("_updatedatastore",{data:i})},CWDatastore._syncStoreToDevice=function(t,e){Connichiwa.send(t,"_updatedatastore",{data:this._data},e)};var CWDebug=CWModules.retrieve("CWDebug");CWDebug._debug=!1,CWDebug._logLevel=0,CWDebug.__constructor=function(){Ractive.DEBUG=!1},CWDebug._setDebugInfo=function(t){t.debug&&CWDebug.setDebug(t.debug),t.logLevel&&CWDebug.setLogLevel(t.logLevel)},CWDebug._getDebugInfo=function(){return{debug:this._debug,logLevel:this._logLevel}},CWDebug.log=function(t,e){this._debug&&t<=this._logLevel&&console.log(t+"|"+e)},CWDebug.err=function(t){this._debug&&console.err(t)},CWDebug.setDebug=function(t){this._debug=t},CWDebug.setLogLevel=function(t){this._logLevel=t},CWDevice.prototype._setProperties=function(t){t.launchDate&&(this._launchDate=t.launchDate),t.ips&&(this._ips=t.ips),t.port&&(this._port=t.port),t.name&&(this._name=t.name),t.ppi&&t.ppi>0&&(this._ppi=t.ppi)},CWDevice.prototype.isLocal=function(){return this.equalTo(Connichiwa.getLocalDevice())},CWDevice.prototype.isNearby=function(){return this._discoveryState===CWDevice.DiscoveryState.DISCOVERED},CWDevice.prototype._canBeConnected=function(){return this._connectionState===CWDevice.ConnectionState.DISCONNECTED&&this._discoveryState===CWDevice.DiscoveryState.DISCOVERED},CWDevice.prototype.isConnected=function(){return this._connectionState===CWDevice.ConnectionState.CONNECTED},CWDevice.prototype.insert=function(t,e){if(void 0===e&&(e=t,t="body"),CWUtil.isObject(t)&&(t=$(t),t="#"+t.attr("id")),CWUtil.isObject(e)===!0){var i=$(e),o=i.clone();o[0].style.cssText=i[0].style.cssText,e=o[0].outerHTML}var n={selector:t,html:e};this.send("_insert",n)},CWDevice.prototype.replace=function(t,e){this._replace(t,e,!1)},CWDevice.prototype.replaceContent=function(t,e){this._replace(t,e,!0)},CWDevice.prototype._replace=function(t,e,i){if(void 0===e&&(e=t,t="body"),CWUtil.isObject(t)&&(t="#"+$(t).attr("id")),CWUtil.isObject(e)===!0){var o=$(e),n=o.clone();n[0].style.cssText=o[0].style.cssText,e=n[0].outerHTML}var a={selector:t,html:e,contentOnly:i};this.send("_replace",a)},CWDevice.prototype.loadScript=function(t,e){{var i={url:t};this.send("_loadscript",i,e)}},CWDevice.prototype.loadCSS=function(t){var e={url:t};this.send("_loadcss",e)},CWDevice.prototype.loadTemplates=function(t){var e={paths:t};this.send("_loadtemplate",e)},CWDevice.prototype.insertTemplate=function(t,e){void 0===e&&(e={});var i=e.onComplete;e.onComplete=void 0;{var o={templateName:t,options:e};this.send("_inserttemplate",o,i)}},CWDevice.prototype.send=function(t,e,i){return e._name=t,e._source=Connichiwa.getIdentifier(),e._target=this.getIdentifier(),Connichiwa._sendObject(e,i)},CWDevice.prototype.equalTo=function(t){return CWDevice.prototype.isPrototypeOf(t)===!1?!1:this.getIdentifier()===t.getIdentifier()},CWDevice.prototype.toString=function(){return this.getIdentifier()},CWDevice.prototype.getIdentifier=function(){return this._identifier},CWDevice.prototype.getDistance=function(){return this._distance},CWDevice.prototype.getLaunchDate=function(){return this._launchDate},CWDevice.prototype.getIPs=function(){return this._ips},CWDevice.prototype.getPort=function(){return this._port},CWDevice.prototype.getName=function(){return this._name},CWDevice.prototype.getPPI=function(){return this._ppi},CWDevice.DiscoveryState={DISCOVERED:"discovered",LOST:"lost"},CWDevice.ConnectionState={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected"};var CWEventManager=CWModules.retrieve("CWEventManager");CWEventManager._callbacks={},CWEventManager.register=function(t,e){if(CWUtil.isString(t)===!1)throw"Event name must be a string";if(CWUtil.isFunction(e)===!1)throw"Event callback must be a function";if(t=t.toLowerCase(),-1===t.indexOf(" "))this._callbacks[t]||(this._callbacks[t]=[]),this._callbacks[t].push(e),CWDebug.log(3,"Attached callback to "+t);else for(var i=t.split(" "),o=0;o<i.length;o++)CWEventManager.register(i[o],e)},CWEventManager.unregister=function(t,e){var i=this;window.setTimeout(function(){if(void 0===e&&CWUtil.isFunction(t)&&(e=t,t=void 0),void 0!==t){if(t=t.toLowerCase(),-1!==t.indexOf(" ")){for(var o=t.split(" "),n=0;n<o.length;n++)CWEventManager.unregister(o[n],e);return}if(void 0===e)return void(t in i._callbacks&&(i._callbacks[t]=void 0,CWDebug.log(3,"Detached ALL callbacks from "+t)));if(t in i._callbacks){var n=0;return $.each(i._callbacks[t],function(o,a){a===e&&(i._callbacks[t].splice(o,1),n++)}),void CWDebug.log(3,"Detached "+n+" callbacks from "+t)}}void 0===t&&void 0!==e&&$.each(i._callbacks,function(t){var o=0;$.each(i._callbacks[t],function(n,a){a===e&&(i._callbacks[t].splice(n,1),o++)}),CWDebug.log(3,"Detached "+o+" callbacks from "+t)})},0)},CWEventManager.trigger=function(t,e){var i=Array.prototype.slice.call(arguments);if(CWUtil.isString(t)===!0?(e=t,t=4,i.shift()):(i.shift(),i.shift()),e=e.toLowerCase(),!this._callbacks[e])return void CWDebug.log(5,"No callbacks  for "+e+" registered");CWDebug.log(t,"Triggering event "+e+" for "+this._callbacks[e].length+" callbacks");for(var o=0;o<this._callbacks[e].length;o++){var n=this._callbacks[e][o];n.apply(null,i)}};var CWGestures=CWModules.retrieve("CWGestures");CWGestures._touchStart=void 0,CWGestures._touchLast=void 0,CWGestures._touchLastVector=void 0,CWGestures._touchCheckable=!1,CWGestures._touchAngleReferenceVector=void 0,CWGestures._touchAngleChangedCount=0,CWGestures.__constructor=function(){var t=this;$(document).ready(function(){t._captureOn($("body"))})},CWGestures._onDown=function(t){this._touchStart=CWUtil.getEventLocation(t,"client")},CWGestures._onMove=function(t){if(void 0!==this._touchStart){var e=CWUtil.getEventLocation(t,"client");if(void 0!==this._touchLast){var i=new CWVector(this._touchStart,e),o=new CWVector(this._touchLast,e);if(this._touchCheckable=this._touchCheckable||i.length()>5,this._touchCheckable&&o.length()>1)if(void 0!==this._touchAngleReferenceVector){var n=o.angleBetween(this._touchAngleReferenceVector);if(n>20){if(this._touchAngleChangedCount++,3===this._touchAngleChangedCount)return this._touchStart=void 0,void(this._touchLast=void 0)}else this._touchAngleReferenceVector=void 0,this._touchAngleChangedCount=0}else if(void 0!==this._touchLastVector){var a=o.angleBetween(this._touchLastVector);a>20&&(this._touchAngleReferenceVector=this._touchLastVector,this._touchAngleChangedCount=1)}o.length()>0&&(this._touchLastVector=o)}this._touchLast=e}},CWGestures._onUp=function(){var t=this._touchStart,e=this._touchLast;if(this._touchStart=void 0,this._touchLast=void 0,this._touchLastVector=void 0,this._touchCheckable=!1,this._touchAngleReferenceVector=void 0,this._touchAngleChangedCount=0,void 0!==t&&void 0!==e){var i=e.x-t.x,o=e.y-t.y,n=Math.sqrt(Math.pow(i,2)+Math.pow(o,2));if(10>=n)return void CWDebug.log(3,"Swipe REJECTED because it was too short ("+n+")");var a=.25;100>n&&(a=.35),50>n&&(a=.4),40>n&&(a=.45),15>n&&(a=.8);var s="invalid";Math.abs(o)<Math.abs(i)*a&&(i>0&&(s="right"),0>i&&(s="left")),Math.abs(i)<Math.abs(o)*a&&(o>0&&(s="down"),0>o&&(s="up"));var r=$(window).height()-window.innerHeight;e.y+=r;var c=e.y<=50,h=e.x<=50,l=e.y>=$(window).height()-50,u=e.x>=$(window).width()-50,d="invalid";if(c&&"up"===s&&(d="top"),h&&"left"===s&&(d="left"),l&&"down"===s&&(d="bottom"),u&&"right"===s&&(d="right"),"invalid"===d)return void CWDebug.log(3,"Swipe REJECTED. Ending: x - "+e.x+"/"+($(window).width()-50)+", y - "+e.y+"/"+($(window).height()-50)+". Direction: "+s+". Edge endings: "+c+", "+u+", "+l+", "+h);"top"===d&&(e.y=0),"left"===d&&(e.x=0),"bottom"===d&&(e.y=$(window).height()),"right"===d&&(e.x=$(window).width());var g={edge:d,x:e.x,y:e.y};CWEventManager.trigger("stitchswipe",g)}},CWGestures._captureOn=function(t){t instanceof jQuery&&(t=t.get(0)),t.addEventListener("mousedown",this._onDown,!0),t.addEventListener("touchstart",this._onDown,!0),t.addEventListener("mousemove",this._onMove,!0),t.addEventListener("touchmove",this._onMove,!0),t.addEventListener("mouseup",this._onUp,!0),t.addEventListener("touchend",this._onUp,!0)};var CWGyroscope=CWModules.retrieve("CWGyroscope");CWGyroscope._lastMeasure=void 0,CWGyroscope._alphaGammaFlipped=!1,CWGyroscope.__constructor=function(){gyro.frequency=500,gyro.startTracking(this._onUpdate.bind(this))},CWGyroscope._onUpdate=function(t){if(null!==t.alpha&&null!==t.beta&&null!==t.gamma&&null!==t.x&&null!==t.y&&null!==t.z){if(void 0===this._lastMeasure&&(this._lastMeasure=t),t.alpha<0||t.gamma>180){this._alphaGammaFlipped=!0;var e=this._lastMeasure.alpha;this._lastMeasure.alpha=this._lastMeasure.gamma,this._lastMeasure.gamma=e}var i=this._alphaGammaFlipped?t.gamma:t.alpha,o=t.beta,n=this._alphaGammaFlipped?t.alpha:t.gamma,a=i-this._lastMeasure.alpha,s=o-this._lastMeasure.beta,r=n-this._lastMeasure.gamma,c={alpha:i,beta:o,gamma:n,delta:{alpha:a,beta:s,gamma:r}};CWEventManager.trigger(5,"gyroscopeUpdate",c);var h=t.x-this._lastMeasure.x,l=t.y-this._lastMeasure.y,u=t.z-this._lastMeasure.z,d={x:t.x,y:t.y,z:t.z,delta:{x:h,y:l,z:u}};CWEventManager.trigger(5,"accelerometerUpdate",d),this._lastMeasure={x:t.x,y:t.y,z:t.z,alpha:i,beta:o,gamma:n}}},CWGyroscope.getLastGyroscopeMeasure=function(){return void 0===this._lastMeasure?void 0:{alpha:this._lastMeasure.alpha,beta:this._lastMeasure.beta,gamma:this._lastMeasure.gamma}},CWGyroscope.getLastAccelerometerMeasure=function(){return void 0===this._lastMeasure?void 0:{x:this._lastMeasure.x,y:this._lastMeasure.y,z:this._lastMeasure.z}},CWLocation.prototype.getGlobal=function(){return{x:this._x,y:this._y,width:this._width,height:this._height}},CWLocation.prototype.getLocal=function(){return CWLocation._toLocal(this._x,this._y,this._width,this._height)},CWLocation.prototype.getGlobalX=function(){return this._x},CWLocation.prototype.getGlobalY=function(){return this._y},CWLocation.prototype.getGlobalWidth=function(){return this._width},CWLocation.prototype.getGlobalHeight=function(){return this._height},CWLocation.prototype.getLocalX=function(){return this.getLocal().x},CWLocation.prototype.getLocalY=function(){return this.getLocal().y},CWLocation.prototype.getLocalWidth=function(){return this.getLocal().width},CWLocation.prototype.getLocalHeight=function(){return this.getLocal().height},CWLocation.prototype.setGlobal=function(t,e,i,o){void 0!==t&&(this._x=t),void 0!==e&&(this._y=e),void 0!==i&&(this._width=i),void 0!==o&&(this._height=o)},CWLocation.prototype.setLocal=function(t,e,i,o){var n=CWLocation._toGlobal(t,e,i,o);this._x=n.x,this._y=n.y,this._width=n.width,this._height=n.height},CWLocation.prototype.setGlobalX=function(t){this.setGlobal(t,this._y,this._width,this._height)},CWLocation.prototype.setGlobalY=function(t){this.setGlobal(this._x,t,this._width,this._height)},CWLocation.prototype.setGlobalWidth=function(t){this.setGlobal(this._x,this._y,t,this._height)},CWLocation.prototype.setGlobalHeight=function(t){this.setGlobal(this._x,this._y,this._width,t)},CWLocation.prototype.setLocalX=function(t){var e=this.getLocal();this.setLocal(t,e.y,e.width,e.height)},CWLocation.prototype.setLocalY=function(t){var e=this.getLocal();this.setLocal(e.x,t,e.width,e.height)},CWLocation.prototype.setLocalWidth=function(t){var e=this.getLocal();this.setLocal(e.x,e.y,t,e.height)},CWLocation.prototype.setLocalHeight=function(t){var e=this.getLocal();this.setLocal(e.x,e.y,e.width,t)},CWLocation.prototype.toString=function(){return JSON.stringify(this.getGlobal())},CWLocation.prototype.copy=function(){return CWLocation.fromString(this.toString())},CWLocation._toGlobal=function(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0);var n={x:t,y:e,width:i,height:o},a=CWStitchManager.getLocalDeviceTransformation();return 0===a.rotation&&(n.y=e,n.x=t,n.width=i,n.height=o),90===a.rotation&&(n.y=a.height*a.scale-t-i,n.x=e,n.width=o,n.height=i),180===a.rotation&&(n.y=a.height*a.scale-e-o,n.x=a.width*a.scale-t-i,n.width=i,n.height=o),270===a.rotation&&(n.y=t,n.x=a.width*a.scale-e-o,n.width=o,n.height=i),n.x+=a.x*a.scale,n.y+=a.y*a.scale,n.x/=a.scale,n.y/=a.scale,n.width/=a.scale,n.height/=a.scale,n},CWLocation._toLocal=function(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0);var n={x:t,y:e,width:i,height:o},a=CWStitchManager.getLocalDeviceTransformation();return 0===a.rotation&&(n.y=e-a.y,n.x=t-a.x,n.width=i,n.height=o),90===a.rotation&&(n.y=t-a.x,n.x=a.height-(e-a.y+o),n.width=o,n.height=i),180===a.rotation&&(n.y=a.height-(e-a.y+o),n.x=a.width-(t-a.x+i),n.width=i,n.height=o),270===a.rotation&&(n.y=a.width-(t-a.x+i),n.x=e-a.y,n.width=o,n.height=i),n.x*=a.scale,n.y*=a.scale,n.width*=a.scale,n.height*=a.scale,n},CWLocation.applyRotation=function(t,e,i,o,n){var a=CWStitchManager.getLocalDeviceTransformation();void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===n&&(n=a.rotation);var s={x:t,y:e,width:i,height:o};return 0===a.rotation&&(s.y=e,s.x=t,s.width=i,s.height=o),90===a.rotation&&(s.y=-t,s.x=e,s.width=o,s.height=i),180===a.rotation&&(s.y=-e,s.x=-t,s.width=i,s.height=o),270===a.rotation&&(s.y=t,s.x=-e,s.width=o,s.height=i),s},CWLocation.fromString=function(t){var e=JSON.parse(t);return new CWLocation(parseFloat(e.x),parseFloat(e.y),parseFloat(e.width),parseFloat(e.height),!1)},CWLocation.fromPoint=function(t,e,i){return new CWLocation(t,e,void 0,void 0,i)},CWLocation.fromSize=function(t,e,i){return new CWLocation(void 0,void 0,t,e,i)};var CWNativeBridge=CWModules.retrieve("CWNativeBridge");CWNativeBridge._runsNative=!1,CWNativeBridge.__constructor=function(){window.RUN_BY_CONNICHIWA_NATIVE===!0&&(this._runsNative=!0)},CWNativeBridge.isRunningNative=function(){return this._runsNative===!0},CWNativeBridge.callOnNative=function(t){if(this.isRunningNative()===!0){var e=Array.prototype.slice.call(arguments);e.shift();var i=window[t];"function"==typeof i?i.apply(null,e):CWDebug.log(1,"ERROR: Tried to call native method with name "+t+", but it doesn't exist!")}},CWNativeBridge.parse=function(){};var CWProximity=CWModules.retrieve("CWProximity");CWProximity.startTracking=function(){CWNativeBridge.callOnNative("nativeCallStartProximityTracking")},CWProximity.stopTracking=function(){CWNativeBridge.callOnNative("nativeCallStopProximityTracking")};var CWStitchManager=CWModules.retrieve("CWStitchManager");CWStitchManager._isStitched=!1,CWStitchManager._deviceTransformation=void 0,CWStitchManager._gyroDataOnStitch=void 0,CWStitchManager.unstitchOnMove=!0,CWStitchManager.ignoreMoveAxis=[],CWStitchManager.__constructor=function(){Connichiwa.on("stitchswipe",this._onLocalSwipe),Connichiwa.on("wasStitched",this._onWasStitched),Connichiwa.on("wasUnstitched",this._onWasUnstitched),Connichiwa.on("gyroscopeUpdate",this._onGyroUpdate),Connichiwa.on("accelerometerUpdate",this._onAccelerometerUpdate)},CWStitchManager._onWasStitched=function(t){this._gyroDataOnStitch=CWGyroscope.getLastGyroscopeMeasure(),this._deviceTransformation=t.deviceTransformation,this._isStitched=!0},CWStitchManager._onWasUnstitched=function(){this._gyroDataOnStitch=void 0,this._deviceTransformation=this.getDefaultDeviceTransformation(),this._isStitched=!1},CWStitchManager._onLocalSwipe=function(t){t.device=Connichiwa.getIdentifier(),t.width=CWSystemInfo.viewportWidth(),t.height=CWSystemInfo.viewportHeight(),Connichiwa.send("master","_stitchswipe",t)},CWStitchManager._onGyroUpdate=function(t){if(this.isStitched()!==!1&&this.unstitchOnMove!==!1){void 0===this._gyroDataOnStitch&&(this._gyroDataOnStitch=t);var e=Math.abs(t.alpha-this._gyroDataOnStitch.alpha),i=Math.abs(t.beta-this._gyroDataOnStitch.beta),o=Math.abs(t.gamma-this._gyroDataOnStitch.gamma);e=Math.abs((e+180)%360-180),i=Math.abs((i+180)%360-180),o=Math.abs((o+180)%360-180),(CWUtil.inArray("alpha",this.ignoreMoveAxis)===!1&&e>=35||CWUtil.inArray("beta",this.ignoreMoveAxis)===!1&&i>=20||CWUtil.inArray("gamma",this.ignoreMoveAxis)===!1&&o>=20)&&this._quitStitch()}},CWStitchManager._onAccelerometerUpdate=function(t){if(this.isStitched()!==!1&&this.unstitchOnMove!==!1){var e=Math.abs(t.x),i=Math.abs(t.y),o=Math.abs(Math.abs(t.z)-9.81);(CWUtil.inArray("x",this.ignoreMoveAxis)===!1&&e>=1||CWUtil.inArray("y",this.ignoreMoveAxis)===!1&&i>=1||CWUtil.inArray("z",this.ignoreMoveAxis)===!1&&o>=1)&&this._quitStitch()}},CWStitchManager._quitStitch=function(){var t={device:Connichiwa.getIdentifier()};Connichiwa.send("master","_quitstitch",t)},CWStitchManager.unstitch=function(){this._quitStitch()},CWStitchManager.isStitched=function(){return this._isStitched},CWStitchManager.getLocalDeviceTransformation=function(){return void 0===this._deviceTransformation?this.getDefaultDeviceTransformation():this._deviceTransformation},CWStitchManager.getDefaultDeviceTransformation=function(){return{x:0,y:0,width:CWSystemInfo.viewportWidth(),height:CWSystemInfo.viewportHeight(),rotation:0,scale:1}};var CWSystemInfo=CWModules.retrieve("CWSystemInfo");CWSystemInfo.DEFAULT_PPI=100,CWSystemInfo.PPI=function(){var t=this.DEFAULT_PPI;return window.devicePixelRatio>1&&(t=142),"iPad"===navigator.platform&&(t=132),("iPhone"===navigator.platform||"iPod"===navigator.platform)&&(t=3===window.devicePixelRatio?153:163),t},CWSystemInfo.isLandscape=function(){return window.innerHeight<window.innerWidth},CWSystemInfo.viewportWidth=function(){return $(window).width()},CWSystemInfo.viewportHeight=function(){return $(window).height()};var CWTemplates=CWModules.retrieve("CWTemplates");CWTemplates._files=[],CWTemplates._templates={raw:{},compiled:[]},CWTemplates.__constructor=function(){var t=this;Connichiwa.on("_datastorechanged",function(e,i){e&&0===e.indexOf("_CWTemplates")&&$.each(i,function(e){$.each(t._templates.compiled,function(t,i){i.update(e)})})})},CWTemplates.load=function(t,e){if(void 0===e&&(e=t,t=void 0),CWUtil.isString(t)&&(t=CWDeviceManager.getDeviceWithIdentifier(t)),CWUtil.isString(e)&&(e=[e]),void 0!==t)return void t.loadTemplates(e);var i=this;$.each(e,function(t,e){if(e in i._files)return!0;var o=new $.Deferred;i._files.push(o),$.get(e).done(function(t){CWDebug.log(3,"Compiling template file "+e);var n=i._compile(t);n?o.resolve():o.reject()}).fail(function(){CWDebug.err("Template file "+e+" does not exist"),o.reject()})})},CWTemplates.insert=function(t,e,i){if(void 0===e?(e=t,t=void 0):CWUtil.isObject(e)&&void 0===i&&(i=e,e=t,t=void 0),void 0===i&&(i={}),CWUtil.isString(t)&&(t=CWDeviceManager.getDeviceWithIdentifier(t)),void 0!==t)return void t.insertTemplate(e,i);var o=i.target||"body",n=i.dataSource,a=i.onComplete,s=this;$.when.all(this._files).always(function(){CWDebug.log(3,"Inserting template "+e+" into DOM");var t;void 0===n?t=CWDatastore._getCollection("_CWTemplates.",!1):CWUtil.isString(n)?t=CWDatastore._getCollection("_CWTemplates."+n,!1):CWUtil.isObject(n)&&(t=n);var i=new Ractive({template:s._templates.raw[e],data:t,el:$(o),append:!0,partials:s._templates.raw});s._templates.compiled.push(i),void 0!==a&&a()})},CWTemplates.set=function(t,e,i){void 0===i&&(i=e,e=t,t=""),CWDatastore.set("_CWTemplates."+t,e,i)},CWTemplates.setMultiple=function(t,e){void 0===e&&(e=t,t=""),CWDatastore.setMultiple("_CWTemplates."+t,e)},CWTemplates.get=function(t,e){return void 0===e&&(e=t,t=""),CWDatastore.get("_CWTemplates."+t,e)},CWTemplates._compile=function(t){var e=$("<wrapper>");e.html(t);var i=this,o=e.find("template"),n=0;return o.each(function(t,e){e=$(e);var o=e.attr("name"),a=CWUtil.unescape(e.html());return void 0===o||0===o.length?(CWDebug.err(1,"Found template without name - template is ignored. Template Content: "+a),!0):(CWDebug.log(3,"Registering template: "+o),i._templates.raw[o]=a,void n++)}),1>n?!1:!0};var CWUtil=CWModules.retrieve("CWUtil");CWUtil.parseURL=function(t){var e=document.createElement("a");return e.href=t,e},CWUtil.unescape=function(t){return t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'")},CWUtil.getEventLocation=function(t,e){void 0===e&&(e="page");var i={x:t[e+"X"],y:t[e+"Y"]};if(void 0===i.x||void 0===i.y){var o=void 0===t.originalEvent?t.targetTouches:t.originalEvent.targetTouches;i={x:o[0][e+"X"],y:o[0][e+"Y"]}}return i},CWUtil.randomInt=function(t,e){return void 0===e&&void 0!==t?(e=t,t=0):void 0===e&&void 0===t&&(t=0,e=Number.MAX_VALUE),Math.floor(Math.random()*(e-t+1))+t},CWUtil.isInt=function(t){return t===parseInt(t)},CWUtil.isString=function(t){return"string"==typeof t},CWUtil.isFunction=function(t){return"function"==typeof t},CWUtil.isObject=function(t){return"object"==typeof t&&null!==t},CWUtil.isArray=function(t){return Array.isArray(t)},CWUtil.inArray=function(t,e){return e.indexOf(t)>-1},CWUtil.createUUID=function(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,CWUtil.createUUID)},CWVector.prototype.deltaX=function(){return this._p2.x-this._p1.x},CWVector.prototype.deltaY=function(){return this._p2.y-this._p1.y},CWVector.prototype.length=function(){return Math.sqrt(Math.pow(this._deltaX,2)+Math.pow(this._deltaY,2))},CWVector.prototype.angleBetween=function(t){var e=this.deltaX()*t.deltaX()+this.deltaY()*t.deltaY(),i=this.length()*t.length();return Math.acos(e/i)*(180/Math.PI)},CWVector.prototype.getP1=function(){return this._p1},CWVector.prototype.getP2=function(){return this._p2};var CWWebsocketMessageParser=CWModules.retrieve("CWWebsocketMessageParser");CWWebsocketMessageParser.parse=function(t){var e;switch(t._name){case"_chunk":e=this._parseChunk(t);break;case"_ack":e=this._parseAck(t);break;case"_insert":e=this._parseInsert(t);break;case"_replace":e=this._parseReplace(t);break;case"_loadscript":e=this._parseLoadScript(t);break;case"_loadcss":e=this._parseLoadCSS(t);break;case"_loadtemplate":e=this._parseLoadTemplate(t);break;case"_inserttemplate":e=this._parseInsertTemplate(t);break;case"_wasstitched":e=this._parseWasStitched(t);break;case"_wasunstitched":e=this._parseWasUnstitched(t);break;case"_gotstitchneighbor":e=this._parseGotStitchNeighbor(t);break;case"_updatedatastore":e=this._parseUpdateDatastore(t)}return e};var chunks={};CWWebsocketMessageParser._parseChunk=function(t){if(t.originalID in chunks==!1&&(chunks[t.originalID]=""),chunks[t.originalID]+=t.payload,!!t.isFinal==!0){var e={};e.data=chunks[t.originalID],Connichiwa._onWebsocketMessage(e),chunks[t.originalID]=void 0}return!1},CWWebsocketMessageParser._parseAck=function(t){return CWEventManager.trigger("__ack_message"+t.original._id),!1},CWWebsocketMessageParser._parseInsert=function(t){return $(t.selector).append(t.html),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseReplace=function(t){return t.contentOnly===!0?$(t.selector).html(t.html):$(t.selector).replaceWith(t.html),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseLoadScript=function(t){var e=new $.Deferred;return $.getScript(t.url).done(function(){e.resolve()}).fail(function(i,o,n){CWDebug.err(1,"There was an error loading '"+t.url+"': "+n),e.reject()}),e},CWWebsocketMessageParser._parseLoadCSS=function(t){var e=document.createElement("link");return e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",t.url),$("head").append(e),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseLoadTemplate=function(t){return CWTemplates.load(t.paths),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseInsertTemplate=function(t){var e=new $.Deferred;return t.options.onComplete=function(){e.resolve()},CWTemplates.insert(t.templateName,t.options),e},CWWebsocketMessageParser._parseWasStitched=function(t){return CWEventManager.trigger("wasStitched",t),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseWasUnstitched=function(t){return CWEventManager.trigger("wasUnstitched",t),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseGotStitchNeighbor=function(t){return CWEventManager.trigger("gotstitchneighbor",t),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseUpdateDatastore=function(t){return $.each(t.data,function(t,e){CWDatastore._set(t,e,!1)}),(new $.Deferred).resolve()};var Connichiwa=CWModules.retrieve("Connichiwa");Connichiwa._websocket=void 0,Connichiwa.getLocalDevice=function(){},Connichiwa.getIdentifier=function(){},Connichiwa.isMaster=function(){},Connichiwa._connectWebsocket=function(){},Connichiwa._onWebsocketOpen=function(){},Connichiwa._onWebsocketMessage=function(){},Connichiwa._onWebsocketClose=function(){},Connichiwa._onWebsocketError=function(){},Connichiwa.__constructor=function(){if(CWNativeBridge.isRunningNative()!==!0&&Connichiwa.isMaster()){var t=new CWUtil.parseURL(document.URL);return void(window.location="http://"+t.hostname+":"+t.port+"/remote")}this._connectWebsocket()},Connichiwa.on=function(t,e){return"load"===t?void this.onLoad(e):void CWEventManager.register(t,e)},Connichiwa.off=function(t,e){CWEventManager.unregister(t,e)},Connichiwa.onMessage=function(t,e){this.on("message"+t,e)},Connichiwa.onLoad=function(t){"complete"===document.readyState?window.setTimeout(t,0):this.on("ready",t)},Connichiwa.send=function(t,e,i,o){return i._name=e,i._source=Connichiwa.getIdentifier(),i._target=t,this._sendObject(i,o)},Connichiwa.respond=function(t,e,i){this.send(t._source,e,i)},Connichiwa.broadcast=function(t,e,i){i&&(e._broadcastToSource=!0),this.send("broadcast",t,e)},Connichiwa._sendAck=function(t){var e={original:{_id:t._id}};this.send(t._source,"_ack",e)},Connichiwa._sendObject=function(t,e){if("_name"in t==!1)return void CWDebug.err("Tried to send message without _name, ignoring: "+JSON.stringify(t));t._id=CWUtil.randomInt(0,9999999999),t._name=t._name.toLowerCase();var i=JSON.stringify(t);return CWDebug.log(4,"Sending message: "+i),void 0!==e&&Connichiwa.on("__ack_message"+t._id,function(){e(),Connichiwa.off("__ack_message"+t._id)}),this._websocket.send(i),t._id},Connichiwa._disconnectWebsocket=function(){this._websocket.close()},Connichiwa._cleanupWebsocket=function(){void 0!==this._websocket&&(this._websocket.onopen=void 0,this._websocket.onmessage=void 0,this._websocket.onclose=void 0,this._websocket.onerror=void 0,this._websocket=void 0)},$.when.all=function(t){var e=new $.Deferred,i=t.length,o=!1;return $.each(t,function(t,n){n.fail(function(){o=!0}).always(function(){i--,0===i&&(o?e.reject():e.resolve())})}),e};var CWNativeBridge=CWModules.retrieve("CWNativeBridge");CWNativeBridge.parse=function(t){var e;switch(CWUtil.isString(t)?(CWDebug.log(4,"Parsing native message (master): "+t),e=JSON.parse(t)):e=t,CWDebug.log(1,"NATIVE PARSE "+e._name),e._name){case"runsnative":this._parseRunsNative(e);break;case"cwdebug":this._parseDebug(e);break;case"localinfo":this._parseLocalInfo(e);break;case"disconnectwebsocket":this._parseDisconnectWebsocket(e);break;case"proximitystatechanged":this._parseProximityStateChanged(e)}},CWNativeBridge._parseLocalInfo=function(t){Connichiwa._setLocalDevice(t),CWEventManager.trigger("ready")},CWNativeBridge._parseDisconnectWebsocket=function(){Connichiwa._disconnectWebsocket()},CWNativeBridge._parseProximityStateChanged=function(t){CWDebug.log(5,"Proximity State Changed: "+t.proximityState),CWEventManager.trigger("proximityStateChanged",t.proximityState)};var CWWebsocketMessageParser=CWModules.retrieve("CWWebsocketMessageParser");CWWebsocketMessageParser.parseOnRemote=function(t){var e;switch(t._name){case"_debuginfo":e=this._parseDebugInfo(t);break;case"_softdisconnect":e=this._parseSoftDisconnect(t)}return e},CWWebsocketMessageParser._parseDebugInfo=function(t){return CWDebug._setDebugInfo(t),(new $.Deferred).resolve()},CWWebsocketMessageParser._parseSoftDisconnect=function(){return Connichiwa._softDisconnectWebsocket(),(new $.Deferred).resolve()};var Connichiwa=CWModules.retrieve("Connichiwa");Connichiwa._localDevice=void 0,Connichiwa._softDisconnected=!1,Connichiwa._isReconnecting=!1,Connichiwa.getLocalDevice=function(){return this._localDevice},Connichiwa.getIdentifier=function(){return this._localDevice.getIdentifier()},Connichiwa.isMaster=function(){return!1},Connichiwa._setLocalDevice=function(t){t.isLocal=!0,void 0===this._localDevice?this._localDevice=new CWDevice(t):this._localDevice._setProperties(t)},Connichiwa._connectWebsocket=function(){CWDebug.log(3,"Connecting");var t=this._websocket;this._cleanupWebsocket(),void 0!==t&&t.close();var e=new CWUtil.parseURL(document.URL);this._websocket=new WebSocket("ws://"+e.hostname+":"+(parseInt(e.port)+1)),this._websocket.onopen=this._onWebsocketOpen,this._websocket.onmessage=this._onWebsocketMessage,this._websocket.onclose=this._onWebsocketClose,this._websocket.onerror=this._onWebsocketError},Connichiwa._onWebsocketOpen=function(){CWDebug.log(3,"Websocket opened"),this._softDisconnected=!1;var t=CWNativeBridge.isRunningNative();if(t===!1&&this._isReconnecting===!0)return void location.reload(!0);var e={identifier:CWUtil.createUUID(),launchDate:Date.now()/1e3,ppi:CWSystemInfo.PPI()};
this._setLocalDevice(e),Connichiwa.send("server","_remote_identification",{identifier:e.identifier}),CWNativeBridge.callOnNative("nativeWebsocketDidOpen"),this.send("master","remoteinfo",e)},Connichiwa._onWebsocketMessage=function(t){var e=JSON.parse(t.data);if("broadcast"!==e._target||e._source!==this.getLocalDevice().getIdentifier()||e._broadcastToSource===!0){CWDebug.log(4,"Received message: "+t.data);window.requestAnimationFrame(function(){var t=CWWebsocketMessageParser.parse(e),i=CWWebsocketMessageParser.parseOnRemote(e);if(e._name&&CWEventManager.trigger("message"+e._name,e),t!==!1&&i!==!1){var o=i;void 0===o&&(o=t),void 0===o&&(o=(new $.Deferred).resolve()),$.when(o).always(function(){Connichiwa._sendAck(e)})}})}},Connichiwa._onWebsocketClose=function(){CWDebug.log(3,"Websocket closed"),this._cleanupWebsocket(),CWNativeBridge.callOnNative("nativeWebsocketDidClose");var t=CWNativeBridge.isRunningNative();t===!1&&window.setTimeout(this._tryWebsocketReconnect,2500)},Connichiwa._onWebsocketError=function(){CWDebug.log(3,"Error"),this._onWebsocketClose()},Connichiwa._softDisconnectWebsocket=function(){this._softDisconnected=!0,CWNativeBridge.callOnNative("nativeSoftDisconnect")},Connichiwa._tryWebsocketReconnect=function(){if(void 0===this._websocket||this._websocket.readyState!==WebSocket.OPEN){if(void 0!==this._websocket&&this._websocket.readyState===WebSocket.CONNECTING)return void window.setTimeout(this._tryWebsocketReconnect,1e3);this._isReconnecting=!0,CWDebug.log(3,"Try reconnect"),this._connectWebsocket(),window.setTimeout(this._tryWebsocketReconnect,2500)}},CWModules.init();
//# sourceMappingURL=remote.min.js.map